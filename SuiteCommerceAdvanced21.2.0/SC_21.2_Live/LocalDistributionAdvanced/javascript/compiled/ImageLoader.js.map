{"version":3,"sources":["ImageLoader.ts"],"names":[],"mappings":"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","file":"ImageLoader.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"ImageLoader\"/>\n/// <reference path=\"../../../Commons/Utilities/JavaScript/UnderscoreExtended.d.ts\" />\n// This module is responsible of of the lazy loading of images - this is loading only those images that are in the current browser's viewport and start loading\n// the other images when the user scrolls into them. In general this module has two parts - first it exposes the function _.printImage() so images with this\n// behavior can be easily printed in templates and then it contains the logic of loading the images when the user scrolls the window.\n// This module won't affect the Page Generator output code - only browser's\n\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\n\nimport BackboneViewRender = require('../../../Commons/BackboneExtras/JavaScript/Backbone.View.render');\n\nconst default_height = 200;\n\nconst image_urls = {};\n\nconst fixImagesForLoader = function(s: string): string {\n    return s.replace(/<img([^>]*)src=\"([^\"]+)\"([^>]*)/gi, function(\n        all,\n        textBefore,\n        url,\n        textAfter\n    ) {\n        if (image_urls[url]) {\n            return all;\n        }\n        textBefore = textBefore || '';\n        textAfter = textAfter || '';\n        // do nothing if image contains data-loader=\"false\" attribute\n        if (\n            (textBefore && textBefore.indexOf('data-loader=\"false\"') !== -1) ||\n            (textAfter && textAfter.indexOf('data-loader=\"false\"') !== -1)\n        ) {\n            return all;\n        }\n        const params = Utils.parseUrlOptions(url);\n        const height = params.resizeh || default_height;\n        const style_attrs: string =\n            'style=\"min-height:' + height + 'px;min-width:' + height + 'px\"';\n        const ret =\n            '<img data-image-status=\"pending\" data-src=\"' +\n            url +\n            '\" ' +\n            style_attrs +\n            textBefore +\n            ' ' +\n            textAfter;\n        return ret;\n    });\n};\n\nconst isElementInViewport = function($el): boolean {\n    if (!$el.is(':visible')) {\n        return false;\n    }\n    const el_rect = {\n        left: $el.offset().left,\n        top: $el.offset().top,\n        bottom: $el.offset().top + $el.height(),\n        right: $el.offset().left + $el.width()\n    };\n    const window_rect = {\n        left: jQuery(window).scrollLeft(),\n        top: jQuery(window).scrollTop(),\n        bottom: jQuery(window).scrollTop() + jQuery(window).height(),\n        right: jQuery(window).scrollLeft() + jQuery(window).width()\n    };\n\n    return rectangleIntercept(el_rect, window_rect);\n};\n\nvar rectangleIntercept = function(r1, r2): boolean {\n    return !(r1.left > r2.right || r1.right < r2.left || r1.top > r2.bottom || r1.bottom < r2.top);\n};\n\n// the main imageloader function resolvePendingImages. It will iterate all images marked with data-image-status=\"pending\" and start loading them.\n// If passed parameter onlyIfVisible is true it will load ony those images that are currently visible.\nconst resolvePendingImages = function(onlyIfVisible: boolean) {\n    jQuery('[data-image-status=\"pending\"]').each(function() {\n        const $image = jQuery(this);\n        if (!onlyIfVisible || isElementInViewport($image)) {\n            const src = $image.attr('data-src');\n            $image\n                .attr({\n                    src: $image.attr('data-src')\n                })\n                .data('image-status', 'done')\n                .on('load error', function() {\n                    $image.attr({ style: '' });\n                    image_urls[src] = true;\n                });\n        }\n    });\n};\n\n// @class ImageLoader @extends ApplicationModule\nexport = {\n    mountToApp: function(application) {\n        if (!Utils.isPageGenerator()) {\n            const handler: any = _.throttle(_(resolvePendingImages).bind(null, true), 200);\n            // we listen when the full document is scrolled and check if there is any pending image and load them if they are visible\n            jQuery(window).on('resize scroll', handler);\n\n            // when a new view is shown we want to check if it contains any visible pending images and load them\n            application.getLayout().on('afterAppendView afterRender', function() {\n                resolvePendingImages(true);\n            });\n\n            // There may be image markup that are there but in hidden parents that may be shown when user clicks or touch something.\n            jQuery('body').on('click touchend', function() {\n                resolvePendingImages(false);\n            });\n        }\n\n        // ADDS RENDER PLUGIN TO HOOK WHEN RENDERING IMAGES\n        BackboneViewRender.postCompile.install({\n            name: 'imageLoader',\n            priority: 40,\n            execute: function(tmpl_str) {\n                if (!Utils.isPageGenerator()) {\n                    tmpl_str = fixImagesForLoader(tmpl_str) || '';\n                }\n\n                return tmpl_str;\n            }\n        });\n    },\n\n    // exposing utility methods so we can test them.\n\n    // @method resolvePendingImages\n    resolvePendingImages: resolvePendingImages,\n\n    // @method rectangleIntercept @param {Rectangle} r1 @param {Rectangle} r2 @returns {Boolean}\n    rectangleIntercept: rectangleIntercept,\n\n    // @method isElementInViewport @param {jQuery|HTMLElement} el @returns {Boolean}\n    isElementInViewport: isElementInViewport,\n\n    // @method fixImagesForLoader\n    fixImagesForLoader: fixImagesForLoader,\n\n    // @property {Number} default_height\n    default_height: default_height\n};\n"]}