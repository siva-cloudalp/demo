{"version":3,"sources":["Loggers.Appender.ElasticLogger.ts"],"names":[],"mappings":"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","file":"Loggers.Appender.ElasticLogger.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"Loggers.Appender.ElasticLogger\"/>\n/// <reference path=\"../../Utilities/JavaScript/GlobalDeclarations.d.ts\" />\n\nimport { Tracker } from './Loggers.Appender.ElasticLogger.Tracker';\nimport { LoggersAppender } from './Loggers.Appender';\nimport * as jQuery from '../../Core/JavaScript/jQuery';\n\nimport Utils = require('../../Utilities/JavaScript/Utils');\nimport * as _ from 'underscore';\n\nexport interface LoggersAppenderElasticLoggerData {\n    suiteScriptAppVersion: string;\n    message: string;\n}\n\nexport class LoggersAppenderElasticLogger implements LoggersAppender {\n    protected static instance: LoggersAppenderElasticLogger;\n\n    /**\n     * Param used to override the start date\n     */\n    public readonly START_PARAM = this.paramBackdatingStart();\n\n    protected paramBackdatingStart(): string {\n        return 'begin';\n    }\n\n    /**\n     * Param used to override the end date\n     */\n    public readonly END_PARAM = this.paramBackdatingEnd();\n\n    protected paramBackdatingEnd(): string {\n        return 'end';\n    }\n\n    /**\n     * Param used to provide the component area\n     */\n    public readonly COMPONENT_AREA_PARAM = this.paramComponentArea();\n\n    protected paramComponentArea(): string {\n        return 'componentArea';\n    }\n\n    /**\n     * Param used to provide the time total\n     */\n    public readonly TIME_TOTAL_PARAM = this.paramTimeTotal();\n\n    protected paramTimeTotal(): string {\n        return 'totalTime';\n    }\n\n    /**\n     * Collection of trackers in progress.\n     */\n    private trackersInProgress: Tracker[] = [];\n\n    private queueErrorTemp = [];\n\n    private queueInfoTemp = [];\n\n    private isWaiting = false;\n\n    private enabled = !SC.isPageGenerator();\n\n    private clearQueues() {\n        localStorage.setItem('queueError', JSON.stringify(this.queueErrorTemp));\n        localStorage.setItem('queueInfo', JSON.stringify(this.queueInfoTemp));\n        this.queueErrorTemp = [];\n        this.queueInfoTemp = [];\n        this.isWaiting = false;\n    }\n\n    private appendTemp() {\n        if (this.queueErrorTemp.length > 0) {\n            const stringQueueError = localStorage.getItem('queueError');\n            const queueError = stringQueueError == null ? [] : JSON.parse(stringQueueError);\n            localStorage.setItem(\n                'queueError',\n                JSON.stringify(queueError.concat(this.queueErrorTemp))\n            );\n        }\n        if (this.queueInfoTemp.length > 0) {\n            const stringQueueInfo = localStorage.getItem('queueInfo');\n            const queueInfo = stringQueueInfo == null ? [] : JSON.parse(stringQueueInfo);\n            localStorage.setItem('queueInfo', JSON.stringify(queueInfo.concat(this.queueInfoTemp)));\n        }\n        this.isWaiting = false;\n    }\n\n    private sendQueues(isAsync: boolean) {\n        const { product } = SC.ENVIRONMENT.BuildTimeInf;\n        const URL = Utils.getAbsoluteUrl(\n            `services/ElasticLogger.ss?n=${SC.ENVIRONMENT.siteSettings.siteid}`,\n            true\n        );\n\n        const queueError = JSON.parse(localStorage.getItem('queueError'));\n        const queueInfo = JSON.parse(localStorage.getItem('queueInfo'));\n        if ((queueInfo && queueInfo.length > 0) || (queueError && queueError.length > 0)) {\n            this.isWaiting = true;\n            const data = {\n                type: product,\n                info: queueInfo,\n                error: queueError\n            };\n            if (navigator.sendBeacon) {\n                const status = navigator.sendBeacon(URL, JSON.stringify(data));\n                if (status) {\n                    this.clearQueues();\n                } else {\n                    this.appendTemp();\n                }\n            } else {\n                jQuery\n                    .ajax({\n                        type: 'POST',\n                        url: URL,\n                        data: JSON.stringify(data),\n                        contentType: 'text/plain; charset=UTF-8',\n                        async: isAsync\n                    })\n                    .done(() => {\n                        this.clearQueues();\n                    })\n                    .fail(() => {\n                        this.appendTemp();\n                    });\n            }\n        }\n    }\n\n    protected constructor() {\n        if (this.enabled) {\n            setInterval(() => {\n                this.sendQueues(true);\n            }, 60000);\n\n            window.addEventListener('beforeunload', () => {\n                this.sendQueues(false);\n            });\n        }\n    }\n\n    public ready(): boolean {\n        return this.enabled;\n    }\n\n    public info(data: LoggersAppenderElasticLoggerData) {\n        data.suiteScriptAppVersion = SC.ENVIRONMENT.RELEASE_METADATA.version;\n        data.message = 'clientSideLogDateTime: ' + new Date().toISOString();\n        if (this.isWaiting) {\n            this.queueInfoTemp.push(data);\n        } else {\n            const queueInfo = JSON.parse(localStorage.getItem('queueInfo')) || [];\n            queueInfo.push(data);\n            localStorage.setItem('queueInfo', JSON.stringify(queueInfo));\n        }\n    }\n\n    public error(data: LoggersAppenderElasticLoggerData) {\n        data.suiteScriptAppVersion = SC.ENVIRONMENT.RELEASE_METADATA.version;\n        data.message = 'clientSideLogDateTime: ' + new Date().toISOString();\n        if (this.isWaiting) {\n            this.queueErrorTemp.push(data);\n        } else {\n            const queueError = JSON.parse(localStorage.getItem('queueError')) || [];\n            queueError.push(data);\n            localStorage.setItem('queueError', JSON.stringify(queueError));\n        }\n    }\n\n    public start(_action: string) {\n        // Generate a new tracker for the action\n        const tracker = new Tracker(_action);\n        this.trackersInProgress.push(tracker);\n\n        // Return the object expected by the facade\n        return {\n            actionId: tracker.getId()\n        };\n    }\n\n    public end(_startOptions, _options) {\n        // Find the tracker in progress and remove it from the collection\n        const tracker: Tracker = _.find(this.trackersInProgress, function(item: Tracker): boolean {\n            return item.getId() === _startOptions.actionId;\n        });\n\n        this.trackersInProgress = _.without<Tracker>(this.trackersInProgress, tracker);\n\n        // Override the start time if provided\n        if (!_.isUndefined(_options[this.START_PARAM])) {\n            tracker.setBegin(_options[this.START_PARAM]);\n        }\n\n        // End the tracking\n        if (_.isUndefined(_options[this.END_PARAM])) {\n            tracker.endTracking();\n        } else {\n            // Override the end date if provided\n            tracker.endTracking(_options[this.END_PARAM]);\n        }\n\n        // Generate data object including user provided parameters\n        const data: LoggersAppenderElasticLoggerData = _.extend(\n            {\n                [this.COMPONENT_AREA_PARAM]: tracker.getActionName(),\n                [this.TIME_TOTAL_PARAM]: tracker.getTotalTime()\n            },\n            _options\n        );\n\n        // Post to ES as info log\n        this.info(data);\n    }\n\n    public static getInstance() {\n        if (!LoggersAppenderElasticLogger.instance) {\n            LoggersAppenderElasticLogger.instance = new LoggersAppenderElasticLogger();\n        }\n\n        return LoggersAppenderElasticLogger.instance;\n    }\n}\n"]}