{"version":3,"sources":["OrderWizard.Module.PaymentMethod.GiftCertificates.ts"],"names":[],"mappings":"AAAA;;;;;EAKE;;;IAgBF,wFAAwF;IACxF,IAAM,8CAA8C,GAAQ,oCAAgB,CAAC,MAAM,CAAC;QAChF,QAAQ,EAAE,sDAAsD;QAEhE,SAAS,EAAE,mDAAmD;QAE9D,MAAM,EAAE;YACJ,aAAa,EAAE,sBAAsB;YACrC,8BAA8B,EAAE,uBAAuB;YACvD,6CAA6C,EAAE,4BAA4B;SAC9E;QAED,UAAU,EAAE;YACR,oCAAgB,CAAC,SAAS,CAAC,UAAU,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACjE,CAAC;QAED,MAAM,EAAE;YACJ,gCAAgC;YAChC,gCAAgC;YAChC,8BAA8B;SACjC;QAED,yEAAyE;QACzE,QAAQ,EAAE;YACN,OAAO,EAAE,CAAC,WAAW,CAAC,uBAAuB,CAAC;QAClD,CAAC;QAED,MAAM,EAAE;YACJ,+FAA+F;YAC/F,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE;gBAClB,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;gBAE3B,OAAO,IAAI,CAAC,GAAG,CAAC,KAAK,EAAE,CAAC;aAC3B;YAED,IAAI,CAAC,gBAAgB;gBACjB,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,KAAK,CAAC;oBACnC,IAAI,EAAE,iBAAiB;iBAC1B,CAAC,IAAI,EAAE,CAAC;YAEb,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;YAE5B,IAAI,CAAC,OAAO,EAAE,CAAC;QACnB,CAAC;QAED,gBAAgB,EAAE;YACd,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,uBAAuB,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;QAC/D,CAAC;QAED,IAAI,EAAE;YACF,IAAI,CAAC,gBAAgB,EAAE,CAAC;QAC5B,CAAC;QAED,OAAO,EAAE;YACL,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACxB,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,uBAAuB,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;QAC9D,CAAC;QAED,MAAM,EAAE;YACJ,IAAI,CAAC,gBAAgB,EAAE,CAAC;QAC5B,CAAC;QAED,sBAAsB,EAAE,UAAS,KAAK;YAClC,IAAM,IAAI,GAAG,IAAI,CAAC;YAElB,KAAK,GAAG,CAAC,CAAC,GAAG,CAAC,KAAK,EAAE,UAAS,IAAI;gBAC9B,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;YAC1B,CAAC,CAAC,CAAC;YAEH,6BAA6B;YAC7B,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC,iBAAiB,EAAE,CAAC;YACjD,6BAA6B;YAC7B,IAAI,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;YAE/C,OAAO,IAAI,QAAQ,CAAC,KAAK,EAAE;iBACtB,IAAI,CACD;gBACI,gBAAgB,EAAE,KAAK;aAC1B,EACD;gBACI,GAAG,EAAE,KAAK,CAAC,cAAc,CAAC,+CAA+C,CAAC;gBAE1E,OAAO,EAAE,UAAS,KAAK,EAAE,UAAU;oBAC/B,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;wBACX,cAAc,EAAE,UAAU,CAAC,cAAc;wBACzC,OAAO,EAAE,UAAU,CAAC,OAAO;wBAC3B,WAAW,EAAE,UAAU,CAAC,WAAW;qBACtC,CAAC,CAAC;gBACP,CAAC;gBAED,KAAK,EAAE,UAAS,KAAK,EAAE,KAAK;oBACxB,KAAK,CAAC,cAAc,GAAG,IAAI,CAAC;oBAC5B,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC;gBAC5D,CAAC;aACJ,CACJ;iBACA,MAAM,CAAC;gBACJ,4BAA4B;gBAC5B,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC,gBAAgB,EAAE,CAAC;gBAChD,4BAA4B;gBAC5B,IAAI,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,IAAI,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;YACpD,CAAC,CAAC,CAAC;QACX,CAAC;QAED,oBAAoB,EAAE,UAAS,CAAC;YAC5B,CAAC,CAAC,cAAc,EAAE,CAAC;YAEnB,IAAM,IAAI,GAAQ,MAAM,CAAM,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC;iBACzC,IAAI,CAAC,eAAe,CAAC;iBACrB,GAAG,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YACnB,IAAM,UAAU,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,UAAS,WAAgB;gBACtE,OAAO,WAAW,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC,IAAI,KAAK,IAAI,CAAC;YAC5D,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,IAAI,EAAE;gBACP,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;oBACpB,SAAS,EAAE,8BAA8B;oBACzC,YAAY,EAAE,KAAK,CAAC,SAAS,CAAC,2BAA2B,CAAC;iBAC7D,CAAC,CAAC;aACN;iBAAM,IAAI,UAAU,EAAE;gBACnB,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;oBACpB,SAAS,EAAE,gCAAgC;oBAC3C,YAAY,EAAE,KAAK,CAAC,SAAS,CAAC,6BAA6B,CAAC;iBAC/D,CAAC,CAAC;aACN;iBAAM;gBACH,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,wBAAwB,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;aAC7E;QACL,CAAC;QAED,qBAAqB,EAAE,UAAS,CAAC;YAC7B,IAAM,IAAI,GAAG,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC;iBACxB,IAAI,CAAC,IAAI,CAAC;iBACV,QAAQ,EAAE,CAAC;YAChB,IAAM,UAAU,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,UAAS,cAAmB;gBACzE,OAAO,cAAc,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC,IAAI,KAAK,IAAI,CAAC;YAC/D,CAAC,CAAC,CAAC;YAEH,IAAI,UAAU,EAAE;gBACZ,IAAM,sBAAsB,GAAG,IAAI,2BAA2B,CAAC;oBAC3D,QAAQ,EAAE,IAAI,CAAC,sBAAsB;oBACrC,kBAAkB,EAAE;wBAChB,OAAO,EAAE,IAAI;wBACb,IAAI,EAAE,IAAI;qBACb;oBACD,KAAK,EAAE,KAAK,CAAC,SAAS,CAAC,yBAAyB,CAAC;oBACjD,IAAI,EAAE,KAAK,CAAC,SAAS,CAAC,wDAAwD,CAAC;oBAC/E,QAAQ,EAAE,IAAI;iBACjB,CAAC,CAAC;gBAEH,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,SAAS,EAAE,CAAC,WAAW,CAAC,sBAAsB,CAAC,CAAC;aAC3E;QACL,CAAC;QAED,sBAAsB,EAAE,UAAS,OAAO;YACpC,OAAO,CAAC,OAAO,CAAC,sBAAsB,CAClC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,wBAAwB,EAAE,EAAE,OAAO,CAAC,IAAI,CAAC,CACtE,CAAC;QACN,CAAC;QAED,wBAAwB,EAAE;YACtB,OAAO,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,gBAAgB,EAAE,UAAS,cAAmB;gBAC5D,OAAO,cAAc,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC,IAAI,CAAC;YACtD,CAAC,CAAC,CAAC;QACP,CAAC;QAED,SAAS,EAAE;YACP,IAAI,CAAC,CAAC,CAAC,gBAAgB,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;YAC3C,oCAAgB,CAAC,SAAS,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QAChE,CAAC;QAED,6BAA6B;QAC7B,sCAAsC;QACtC,0BAA0B,EAAE,UAAS,CAAC;YAClC,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC;iBACX,IAAI,CAAC,oBAAoB,CAAC;iBAC1B,KAAK,EAAE,CAAC;QACjB,CAAC;QAED,gCAAgC;QAChC,UAAU,EAAE;YACR,uBAAuB,EAAE;gBACrB,OAAO,IAAI,sBAAsB,CAAC;oBAC9B,UAAU,EAAE,IAAI,CAAC,gBAAgB;oBACjC,SAAS,EAAE,oDAAoD;oBAC/D,WAAW,EAAE,CAAC;iBACjB,CAAC,CAAC;YACP,CAAC;SACJ;QAED,uFAAuF;QACvF,UAAU,EAAE;YACR,mEAAmE;YACnE,OAAO;gBACH,gCAAgC;gBAChC,UAAU,EAAE,IAAI,CAAC,QAAQ,EAAE;gBAC3B,0CAA0C;gBAC1C,mBAAmB,EAAE,IAAI,CAAC,gBAAgB,CAAC,MAAM,GAAG,CAAC;aACxD,CAAC;QACN,CAAC;KACJ,CAAC,CAAC;IAEH,OAAS,8CAA8C,CAAC","file":"OrderWizard.Module.PaymentMethod.GiftCertificates.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"OrderWizard.Module.PaymentMethod.GiftCertificates\"/>\n/// <reference path=\"../../../Commons/Utilities/JavaScript/GlobalDeclarations.d.ts\" />\n\nimport * as _ from 'underscore';\nimport * as order_wizard_paymentmethod_giftcertificates_module_tpl from 'order_wizard_paymentmethod_giftcertificates_module.tpl';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { WizardStepModule } from '../../Wizard/JavaScript/Wizard.StepModule';\n\nimport OrderWizardModulePaymentMethodGiftCertificatesRecord = require('./OrderWizard.Module.PaymentMethod.GiftCertificates.Record');\nimport GlobalViewsConfirmationView = require('../../../Commons/GlobalViews/JavaScript/GlobalViews.Confirmation.View');\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\nimport BackboneCollectionView = require('../../../Commons/Backbone.CollectionView/JavaScript/Backbone.CollectionView');\n\n// @class OrderWizard.Module.PaymentMethod.GiftCertificates @extends WizardModule.extend\nconst OrderWizardModulePaymentMethodGiftCertificates: any = WizardStepModule.extend({\n    template: order_wizard_paymentmethod_giftcertificates_module_tpl,\n\n    className: 'OrderWizard.Module.PaymentMethod.GiftCertificates',\n\n    events: {\n        'submit form': 'applyGiftCertificate',\n        'click [data-action=\"remove\"]': 'removeGiftCertificate',\n        'shown [data-action=\"gift-certificate-form\"]': 'onShownGiftCertificateForm'\n    },\n\n    initialize: function() {\n        WizardStepModule.prototype.initialize.apply(this, arguments);\n    },\n\n    errors: [\n        'ERR_WS_INVALID_GIFTCERTIFICATE',\n        'ERR_WS_APPLIED_GIFTCERTIFICATE',\n        'ERR_WS_EMPTY_GIFTCERTIFICATE'\n    ],\n\n    // Determines if the current module is valid to be shown and operate with\n    isActive: function() {\n        return SC.ENVIRONMENT.giftCertificatesEnabled;\n    },\n\n    render: function() {\n        // Is Active is overridden by child modules, like Shipping to hide this module in Multi Ship To\n        if (!this.isActive()) {\n            this.$el.attr('class', '');\n\n            return this.$el.empty();\n        }\n\n        this.giftCertificates =\n            this.model.get('paymentmethods').where({\n                type: 'giftcertificate'\n            }) || [];\n\n        this.trigger('ready', true);\n\n        this._render();\n    },\n\n    eventHandlersOff: function() {\n        this.model.off('change:paymentmethods', this.render, this);\n    },\n\n    past: function() {\n        this.eventHandlersOff();\n    },\n\n    present: function() {\n        this.eventHandlersOff();\n        this.model.on('change:paymentmethods', this.render, this);\n    },\n\n    future: function() {\n        this.eventHandlersOff();\n    },\n\n    updateGiftCertificates: function(codes) {\n        const self = this;\n\n        codes = _.map(codes, function(code) {\n            return { code: code };\n        });\n\n        // disable navigation buttons\n        this.wizard.getCurrentStep().disableNavButtons();\n        // disable inputs and buttons\n        this.$('input, button').prop('disabled', true);\n\n        return new Backbone.Model()\n            .save(\n                {\n                    giftcertificates: codes\n                },\n                {\n                    url: Utils.getAbsoluteUrl('services/LiveOrder.GiftCertificate.Service.ss'),\n\n                    success: function(model, attributes) {\n                        self.model.set({\n                            paymentmethods: attributes.paymentmethods,\n                            summary: attributes.summary,\n                            touchpoints: attributes.touchpoints\n                        });\n                    },\n\n                    error: function(model, jqXhr) {\n                        jqXhr.preventDefault = true;\n                        self.wizard.manageError(JSON.parse(jqXhr.responseText));\n                    }\n                }\n            )\n            .always(function() {\n                // enable navigation buttons\n                self.wizard.getCurrentStep().enableNavButtons();\n                // enable inputs and buttons\n                self.$('input, button').prop('disabled', false);\n            });\n    },\n\n    applyGiftCertificate: function(e) {\n        e.preventDefault();\n\n        const code: any = String(<any>jQuery(e.target)\n            .find('[name=\"code\"]')\n            .val()).trim();\n        const is_applied = _.find(this.giftCertificates, function(certificate: any) {\n            return certificate.get('giftcertificate').code === code;\n        });\n\n        if (!code) {\n            this.wizard.manageError({\n                errorCode: 'ERR_WS_EMPTY_GIFTCERTIFICATE',\n                errorMessage: Utils.translate('Gift Certificate is empty')\n            });\n        } else if (is_applied) {\n            this.wizard.manageError({\n                errorCode: 'ERR_WS_APPLIED_GIFTCERTIFICATE',\n                errorMessage: Utils.translate('Gift Certificate is applied')\n            });\n        } else {\n            this.updateGiftCertificates(this.getGiftCertificatesCodes().concat(code));\n        }\n    },\n\n    removeGiftCertificate: function(e) {\n        const code = jQuery(e.target)\n            .data('id')\n            .toString();\n        const is_applied = _.find(this.giftCertificates, function(payment_method: any) {\n            return payment_method.get('giftcertificate').code === code;\n        });\n\n        if (is_applied) {\n            const deleteConfirmationView = new GlobalViewsConfirmationView({\n                callBack: this._removeGiftCertificate,\n                callBackParameters: {\n                    context: this,\n                    code: code\n                },\n                title: Utils.translate('Remove Gift certificate'),\n                body: Utils.translate('Are you sure you want to remove this Gift certificate?'),\n                autohide: true\n            });\n\n            this.wizard.application.getLayout().showInModal(deleteConfirmationView);\n        }\n    },\n\n    _removeGiftCertificate: function(options) {\n        options.context.updateGiftCertificates(\n            _.without(options.context.getGiftCertificatesCodes(), options.code)\n        );\n    },\n\n    getGiftCertificatesCodes: function() {\n        return _.map(this.giftCertificates, function(payment_method: any) {\n            return payment_method.get('giftcertificate').code;\n        });\n    },\n\n    showError: function() {\n        this.$('.control-group').addClass('error');\n        WizardStepModule.prototype.showError.apply(this, arguments);\n    },\n\n    // onShownGiftCertificateForm\n    // Handles the shown of promocode form\n    onShownGiftCertificateForm: function(e) {\n        jQuery(e.target)\n            .find('input[name=\"code\"]')\n            .focus();\n    },\n\n    // @property {Object} childViews\n    childViews: {\n        GiftCertificatesRecords: function() {\n            return new BackboneCollectionView({\n                collection: this.giftCertificates,\n                childView: OrderWizardModulePaymentMethodGiftCertificatesRecord,\n                viewsPerRow: 1\n            });\n        }\n    },\n\n    // @method getContext @return OrderWizard.Module.PaymentMethod.GiftCertificates.Context\n    getContext: function() {\n        // @class OrderWizard.Module.PaymentMethod.GiftCertificates.Context\n        return {\n            // @property {String} pageHeader\n            pageHeader: this.getTitle(),\n            // @property {Boolean} hasGiftCertificates\n            hasGiftCertificates: this.giftCertificates.length > 0\n        };\n    }\n});\n\nexport = OrderWizardModulePaymentMethodGiftCertificates;\n"]}