{"version":3,"sources":["CheckoutSkipLogin.ts"],"names":[],"mappings":"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","file":"CheckoutSkipLogin.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"CheckoutSkipLogin\"/>\n\n/*\n@module CheckoutSkipLogin\nCheckout Skip Login mode. The Checkout Skip Login is a feature that\nis disabled by default and can be enabled by setting property checkoutApp.skipLogin\nto true in backend.configuration.js file.\n\nBasically for implementing skip login what we are doing is\noverriding the ```save()``` method of the following models:\n```LiveOrderModel```, ```AddressModel```, ```CreditCardModel``` and\t```ProfileModel```.\n\nThe objective is to first call register-guest service and only then\ncall the real save() so the operation is made with a guest session.\n*/\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { ProfileModel } from '../../../Commons/Profile/JavaScript/Profile.Model';\nimport { AddressModel } from '../../../Commons/Address/JavaScript/Address.Model';\nimport { PaymentMethodModel } from '../../PaymentMethod/JavaScript/PaymentMethod.Model';\n\nimport AccountRegisterAsGuestModel = require('../../Account/JavaScript/Account.RegisterAsGuest.Model');\nimport LiveOrderModel = require('../../../Commons/LiveOrder/JavaScript/LiveOrder.Model');\n\n\nlet promise_guest = null;\n\nexport function mountToApp(application) {\n    const { checkoutApp } = application.getConfig();\n    // do nothing if the mode is disabled\n    if (!checkoutApp.skipLogin) {\n        return;\n    }\n\n    // this function is called only if skip login mode is enabled\n    const registerUserAsGuest = function registerUserAsGuest() {\n        const promise = jQuery.Deferred();\n        const profile_model = ProfileModel.getInstance();\n\n        if (profile_model.get('isGuest') === 'F' && profile_model.get('isLoggedIn') === 'F') {\n            const checkout_step = application.getLayout().currentView.currentStep;\n\n            if (checkout_step) {\n                checkout_step.disableNavButtons();\n            }\n\n            new AccountRegisterAsGuestModel().save().done(function(data) {\n                const skip_login_dont_update_profile = profile_model.get(\n                    'skipLoginDontUpdateProfile'\n                );\n                const current_view = application.getLayout().currentView;\n\n                if (skip_login_dont_update_profile && data.user) {\n                    _.each(skip_login_dont_update_profile, function(attr: any) {\n                        delete data.user[attr];\n                    });\n                }\n\n                if (data.user) {\n                    profile_model.set(data.user);\n                }\n\n                current_view.wizard.options.profile = profile_model;\n\n                if (data.touchpoints) {\n                    application.setConfig('siteSettings.touchpoints', data.touchpoints);\n                }\n\n                promise.resolve();\n\n                if (checkout_step) {\n                    checkout_step.enableNavButtons();\n                }\n\n                current_view.$('[data-action=\"skip-login-message\"]').remove();\n            });\n        } else {\n            promise.resolve();\n        }\n        return promise;\n    };\n\n    // add 'this.application' to models that doesn't have it.\n    AddressModel.prototype.application = application;\n    PaymentMethodModel.prototype.application = application;\n    ProfileModel.prototype.application = application;\n\n    // wrap save() method to LiveOrderModel, AddressModel and CreditCardModel\n    const wrapperCheckoutSkipLogin = function wrapperCheckoutSkipLogin(superFn) {\n        const self = this;\n        const super_arguments = Array.prototype.slice.apply(arguments, [1, arguments.length]);\n        const promise: any = jQuery.Deferred();\n\n        if (!promise_guest) {\n            promise_guest = registerUserAsGuest();\n        }\n\n        let result;\n        promise_guest.done(function() {\n            result = superFn.apply(self, super_arguments);\n\n            if (result) {\n                result\n                    .done(function() {\n                        promise.resolve.apply(result, arguments);\n                    })\n                    .fail(function() {\n                        promise.reject.apply(result, arguments);\n                    });\n            } else {\n                // Notify future promises that a front end validation\n                // took place and no promise is returned\n                promise.frontEndValidationError = true;\n                promise.reject.apply(result, super_arguments);\n            }\n        });\n\n        _(promise).extend({\n            error: function() {\n                return this;\n            },\n            success: function() {\n                return this;\n            },\n            abort: () => {\n                promise_guest.done(() => {\n                    if (result) {\n                        result.abort();\n                    }\n                });\n            }\n        });\n\n        return promise;\n    };\n\n    // Site Builder cart is in Checkout :/ don't wrap if in shopping\n    if (Utils.isInCheckout()) {\n        LiveOrderModel.prototype.save = _.wrap(\n            LiveOrderModel.prototype.save,\n            wrapperCheckoutSkipLogin\n        );\n    }\n\n    AddressModel.prototype.save = _.wrap(AddressModel.prototype.save, wrapperCheckoutSkipLogin);\n\n    PaymentMethodModel.prototype.save = _.wrap(\n        PaymentMethodModel.prototype.save,\n        wrapperCheckoutSkipLogin\n    );\n\n    ProfileModel.prototype.save = _.wrap(ProfileModel.prototype.save, wrapperCheckoutSkipLogin);\n}\n"]}