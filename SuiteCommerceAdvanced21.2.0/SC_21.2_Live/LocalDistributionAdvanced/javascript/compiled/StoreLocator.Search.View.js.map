{"version":3,"sources":["StoreLocator.Search.View.ts"],"names":[],"mappings":"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","file":"StoreLocator.Search.View.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"StoreLocator.Search.View\"/>\n// @module StoreLocator.Search.View\n\nimport * as _ from 'underscore';\nimport * as store_locator_search_tpl from 'store_locator_search.tpl';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { Configuration } from '../../SCA/JavaScript/Configuration';\nimport { AjaxRequestsKiller } from '../../../Commons/AjaxRequestsKiller/JavaScript/AjaxRequestsKiller';\n\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\nimport BackboneView = require('../../../Commons/BackboneExtras/JavaScript/Backbone.View');\nimport BackboneFormView = require('../../../Commons/Backbone.FormView/JavaScript/Backbone.FormView');\n\nconst StoreLocatorSearchView: any = BackboneView.extend({\n    template: store_locator_search_tpl,\n\n    events: {\n        'click [data-action=\"use-geolocation\"]': 'useGeolocation',\n        'submit form': 'saveFormCustom',\n        'keypress [name=\"city\"]': 'saveFormCustom'\n    },\n\n    // @method saveFormCustom Saves the form but preventing collision with google maps by using a timeout\n    // @param {jQuery.Event} e jQuery event\n    saveFormCustom: function saveFormCustom(e) {\n        if ((e.type === 'keypress' && e.keyCode === 13) || e.type === 'submit') {\n            e.preventDefault();\n            e.stopPropagation();\n\n            const self = this;\n            const args = arguments;\n\n            setTimeout(function() {\n                self.saveForm.apply(self, args);\n            }, 500);\n        }\n    },\n\n    // @method initialize\n    // @param {Object} options\n    initialize: function initialize(options) {\n        this.model = new Backbone.Model();\n\n        const view = this;\n\n        this.model.validation = {\n            city: {\n                fn: function(value) {\n                    const position = view.reference_map.getPosition();\n\n                    if (!value) {\n                        return Utils.translate('Please select an address.');\n                    }\n                    if (value && !position) {\n                        return Utils.translate('Address not found.');\n                    }\n                    if (position.address !== value) {\n                        return Utils.translate('Please select a valid address.');\n                    }\n                }\n            }\n        };\n\n        this.model.sync = _.bind(this.findStores, this);\n\n        BackboneFormView.add(this, {\n            noCloneModel: true\n        });\n\n        this.application = options.application;\n\n        this.reference_map = options.reference_map;\n\n        this.collection = options.collection;\n\n        this.profileModel = options.profileModel;\n\n        const self = this;\n        const position_promise = jQuery.Deferred();\n        const store_locator_last_search = this.profileModel.get('storeLocator_last_search');\n        const position = this.reference_map.getPosition();\n\n        if (!position.refineSearch) {\n            if (store_locator_last_search) {\n                this.reference_map.setPosition({\n                    latitude: store_locator_last_search.latitude,\n                    longitude: store_locator_last_search.longitude,\n                    address: store_locator_last_search.address\n                });\n\n                position_promise.resolve();\n            } else if (this.options.useGeolocation) {\n                this.getCurrentPositionGeolocation().done(function() {\n                    position_promise.resolve();\n                });\n            }\n        }\n\n        position_promise.done(function() {\n            self.findStores();\n        });\n\n        this.collection.on('sync, reset', this.render, this);\n\n        this.reference_map.on('change:position', function() {\n            self.setInputValue();\n        });\n    },\n\n    // @method render\n    render: function render() {\n        if (!this.options.alwaysVisible && this.collection.length) {\n            this.$el.empty();\n            return this;\n        }\n\n        this._render();\n\n        const self = this;\n\n        this.$input = this.$('[data-type=\"autocomplete-input\"]');\n\n        this.reference_map.load().done(function() {\n            self.reference_map.showAutoCompleteInput(self.$input.get(0));\n            self.setInputValue();\n        });\n\n        return this;\n    },\n\n    // @method setInputValue\n    // @return {void}\n    setInputValue: function setInputValue() {\n        const position = this.reference_map.getPosition();\n\n        if (position) {\n            this.$input && this.$input.val(position.address);\n        }\n    },\n\n    getCurrentPositionGeolocation: function getCurrentPositionGeolocation() {\n        const promise = jQuery.Deferred();\n        const self = this;\n\n        this.reference_map\n            .getCurrentPositionGeolocation()\n            .done(function() {\n                self.reference_map.load().done(function() {\n                    self.reference_map.getCityGeoCode().done(function() {\n                        promise.resolveWith(self, self.reference_map.getPosition());\n                    });\n                });\n            })\n            .fail(function(error) {\n                promise.rejectWith(self, arguments);\n                self.blockPosition(error);\n            });\n\n        return promise;\n    },\n\n    // @method useGeolocation\n    useGeolocation: function useGeolocation() {\n        this.reference_map.clearPointList();\n\n        const self = this;\n\n        this.$('[data-action=\"message-warning\"]').hide();\n\n        this.getCurrentPositionGeolocation().done(function() {\n            self.findStores();\n        });\n    },\n\n    // @method blockPosition\n    // @param {PositionError} error\n    blockPosition: function blockPosition(error) {\n        switch (error.code) {\n            case error.PERMISSION_DENIED:\n                this.$('[data-action=\"message-warning\"]')\n                    .html(Utils.translate('To use this functionality enable geolocation.'))\n                    .show();\n                break;\n            case error.POSITION_UNAVAILABLE:\n                this.$('[data-action=\"message-warning\"]')\n                    .html(Utils.translate('Location information is unavailable.'))\n                    .show();\n                break;\n            case error.TIMEOUT:\n                this.$('[data-action=\"message-warning\"]')\n                    .html(Utils.translate('The request to get user location timed out.'))\n                    .show();\n                break;\n            case error.UNKNOWN_ERROR:\n                this.$('[data-action=\"message-warning\"]')\n                    .html(Utils.translate('An unknown error occurred.'))\n                    .show();\n                break;\n        }\n    },\n\n    // @method findStores Find stores according to location\n    // @param {String} method The http method used\n    // @param {model} The model used in the form\n    // @param {jQuery.Deferred} callbacks\n    findStores: function findStores(method, model, callbacks) {\n        this.collection.reset();\n\n        const position = this.reference_map.getPosition();\n\n        if (position && position.address) {\n            this.profileModel.set('storeLocator_last_search', position);\n\n            return this.collection.update(\n                {\n                    latitude: position.latitude,\n                    longitude: position.longitude,\n                    radius: this.reference_map.configuration.getRadius(),\n                    sort: 'distance',\n                    page: 'all',\n                    killerId: AjaxRequestsKiller.getKillerId(),\n                    reset: true,\n                    locationtype: Configuration.get('storeLocator.defaultTypeLocations')\n                },\n                callbacks\n            );\n        }\n    },\n\n    // @method getContext\n    // @return StoreLocator.Location.View.Context\n    getContext: function getContext() {\n        return {\n            showUseCurrentLocationButton: this.options.useGeolocation,\n\n            showResults: !!this.collection.length\n        };\n    }\n});\n\nexport = StoreLocatorSearchView;\n"]}