{"version":3,"sources":["OrderWizard.Module.PaymentMethod.ThreeDSecure.ts"],"names":[],"mappings":"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","file":"OrderWizard.Module.PaymentMethod.ThreeDSecure.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"OrderWizard.Module.PaymentMethod.ThreeDSecure\"/>\n\nimport '../../../Commons/Transaction/JavaScript/Transaction.Model';\nimport * as _ from 'underscore';\nimport * as order_wizard_paymentmethod_threedsecure_module_tpl from 'order_wizard_paymentmethod_threedsecure_module.tpl';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport { WizardStepModule } from '../../Wizard/JavaScript/Wizard.StepModule';\n\nimport Deferred = JQuery.Deferred;\n\nconst OrderWizardModulePaymentMethodThreeDSecure: any = WizardStepModule.extend({\n    // @property {Function} template\n    template: order_wizard_paymentmethod_threedsecure_module_tpl,\n\n    // @property {String} title\n    title: Utils.translate('Credit Card Authentication'),\n    // @property {Object} addressType\n    steps: {\n        DEVICE_AUTHENTICATION: 'authenticatedevice',\n        SHOPPER_CHALLENGE: 'challengeshopper'\n    },\n    // @method initialize\n    // @param {Object} options\n    initialize: function (options) {\n        this.application = options.application;\n        this.deferred = options.deferred;\n        this.confirmation = options.confirmation;\n        this.visible = options.confirmation && options.confirmation.reasoncode !== 'ERR_WS_REQ_DEVICE_AUTHENTICATION';\n        this.serviceHTML = options.confirmation.authenticationformaction ? this.createIFrame(options.confirmation.authenticationformaction) : this.confirmation.get('paymentauthorization').servicehtml;\n\n        this.receiveMessage = this.receiveMessage.bind(this);\n\n        this.currentStep = this.steps.DEVICE_AUTHENTICATION;\n\n        WizardStepModule.prototype.initialize.apply(this, arguments);\n    },\n\n    // @method render\n    // @return {Backbone.View} result\n    render: function () {\n        return WizardStepModule.prototype.render.apply(this, arguments);\n    },\n\n    // @method showInModal\n    // @param {Object} options\n    // @return {jQuery.Deferred}\n    showInModal: function (options) {\n        const error = this.error;\n        if (error) {\n        this.render();\n        }\n\n        const promise = this.application\n            .getLayout()\n            .showInModal(this, _.extend({ keyboard: false, backdrop: 'static' }, options));\n\n        promise.done(() => {\n            this.listenForCallback();\n\n            if (!this.visible) {\n                //Hidden iframe for device authentication\n                this.$containerModal\n                    .addClass('invisible')\n                    .removeClass('fade');\n            } else if (!error) {\n                //Visible iframe for shopper challenge\n                this.$containerModal\n                    .removeClass('invisible')\n                    .addClass('fade');\n\n                this.on('modal-close', () => {\n                    this.model.fetch().done(() => {\n                        this.model.set('internalid', 'cart');\n                        this.model.unset('3dsecure_error');\n                        this.wizard.getCurrentStep().enableNavButtons();\n                    });\n                });\n            }\n        });\n\n        return promise;\n    },\n\n    // @method process3DSecure. Called from ssp 3D Secure file (threedsecure.ssp)\n    // @param {Json} confirmation Order submit answer.\n    process3DSecure: function (order_info) {\n        if (order_info.confirmation && order_info.confirmation.confirmationnumber) {\n            this.model.set(order_info);\n            this.success();\n        } else if (\n            order_info.confirmation &&\n            order_info.confirmation.reasoncode === 'ERR_WS_REQ_SHOPPER_CHALLENGE'\n        ) {\n            this.currentStep = this.steps.SHOPPER_CHALLENGE;\n            this.visible = true;\n            this.serviceHTML = this.createIFrame(order_info.confirmation.authenticationformaction);\n            this.showInModal();\n        } else if (\n            order_info.confirmation &&\n            order_info.confirmation.reasoncode === 'ERR_WS_REQUIRE_CUSTOMER_LOGIN' &&\n            order_info.confirmation.body !== '' &&\n            !!this.currentStep\n        ) {\n            // calls to threedsecure.ssp coming from external sites may fail,\n            // it needs to be triggered again from samesite.\n            if (this.currentStep === this.steps.DEVICE_AUTHENTICATION) {\n                this.currentStep = this.steps.SHOPPER_CHALLENGE;\n            } else if (this.currentStep === this.steps.SHOPPER_CHALLENGE) {\n                delete this.currentStep;\n            }\n            let returnedParameters = order_info.confirmation.body.replace(\n                /([^&=]+=null&)*(&[^&=]+=null)?/g,\n                ''\n            );\n            returnedParameters = encodeURIComponent(\n                '{\"' + returnedParameters.replace(/( |&amp;)/g, '\", \"').replace(/=/g, '\": \"') + '\"}'\n            );\n            this.serviceHTML = this.createIFrame(\n                Utils.getAbsoluteUrl(`threedsecureProxy.ssp?data=${returnedParameters}`)\n            );\n            this.showInModal();\n        } else {\n            this.fail(order_info.errorMessage);\n        }\n    },\n\n    // @method listenForCallback. Turns callback widely available. Emptying it after use\n    listenForCallback: function () {\n        (<any>window).process3DSecure = data => {\n            (<any>window).process3DSecure = function () { };\n            this.process3DSecure(data);\n        };\n\n        (<any>window).addEventListener('message', this.receiveMessage, false);\n    },\n\n    // @method receiveMessage. listen for 3d secure 2.0 response. postMessage flow.\n    receiveMessage: function(event) {\n        if (!new RegExp(event.origin).test(this.serviceHTML)) {\n            throw new Error('Invalid Origin');\n        }\n\n        this.visible = false;\n        this.serviceHTML = this.createIFrame(\n            Utils.getAbsoluteUrl(`threedsecure.ssp?data=${event.data}`)\n        );\n        this.showInModal();\n    },\n\n    // @method fail Called if confirmation coming from 3D Secure ssp file fails.\n    // @return {jQuery.Deferred} Rejected promise.\n    fail: function (errorMessage: string): Deferred<string> {\n        this.closeModal();\n        this.model.set('internalid', 'cart');\n        return this.deferred.rejectWith(this, [errorMessage]);\n    },\n\n    // @method success Called if confirmation coming from 3D Secure ssp file succeeded.\n    // @return {jQuery.Deferred} Resolved promise.\n    success: function () {\n        this.closeModal();\n        return this.deferred.resolve();\n    },\n\n    // @method closeModal Closes the modal\n    closeModal: function () {\n        this.$containerModal\n            .removeClass('fade')\n            .modal('hide')\n            .data('bs.modal', null);\n\n        (<any>window).removeEventListener('message', this.receiveMessage, false);\n    },\n\n    createIFrame: function (action: string): string {\n        return (\n            \"<iframe src='\" +\n            action +\n            \"' id='3dform' name='threedsecureframe' width='100%' height=600 border=0 frameborder=0></iframe>\"\n        );\n    },\n\n    // @method getContext\n    // @return {OrderWizard.Module.PaymentMethod.ThreeDSecure.Context}\n    getContext: function () {\n        return {\n            threeDSecureError: this.model.get('3dsecure_error'),\n            iframe: this.serviceHTML\n        };\n    }\n});\n\nexport = OrderWizardModulePaymentMethodThreeDSecure;\n"]}