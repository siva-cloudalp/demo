{"version":3,"sources":["OrderWizard.Router.ts"],"names":[],"mappings":"AAAA;;;;;EAKE;;;IAoBF,mDAAmD;IACnD,IAAM,iBAAiB,GAAQ,YAAY,CAAC,MAAM,CAAC;QAC/C,oCAAoC;QACpC,IAAI,EAAE,eAAe;QACrB,IAAI,EAAE,eAAe;QACrB,qBAAqB;QACrB,UAAU,EAAE;YACR,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC,WAAW,EAAE,CAAC;YAEvD,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC,SAAS,CAAC,UAAU,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;YAC7E,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YAEnD,IAAI,CAAC,YAAY,GAAG,4BAAY,CAAC,WAAW,EAAE,CAAC;YAE/C,IAAM,eAAe,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;YACzD,IAAM,0BAA0B,GAAG,eAAe,CAAC,SAAS,CAAC,EAAE,IAAI,EAAE,YAAY,EAAE,CAAC,CAAC;YACrF,IAAM,WAAW,GACb,0BAA0B,IAAI,0BAA0B,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;YAE/E,+BAA+B;YAC/B,IAAI,WAAW,IAAI,WAAW,CAAC,UAAU,KAAK,YAAY,EAAE;gBACxD,eAAe,CAAC,MAAM,CAAC,0BAA0B,CAAC,CAAC;aACtD;YAEO,IAAA,mBAAmB,GAAK,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,oBAAjC,CAAkC;YAC7D,IAAI,mBAAmB,IAAI,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,CAAC,EAAE;gBACzD,IAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;gBAE3D,QAAQ,CAAC,gBAAgB,CAAC;oBACtB,IAAI,EAAE,UAAU;oBAChB,MAAM,EAAE,CAAC,EAAE,EAAE,WAAW,CAAC;oBACzB,QAAQ,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC;oBACxC,eAAe,EAAE;wBACb,IAAI,EAAE,YAAY;wBAClB,WAAW,EAAE,sBAAsB;wBACnC,SAAS,EAAE,KAAK,CAAC,wCAAwC,CACrD,iCAAiC,CACpC;qBACJ;iBACJ,CAAC,CAAC;aACN;QACL,CAAC;QACD,sBAAsB;QACtB,WAAW,EAAE;YACT,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;QAC5E,CAAC;QAED,iBAAiB,EAAE,SAAS,iBAAiB,CAAC,OAAO;YACjD,IAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;YAE3D,QAAQ,CAAC,gBAAgB,CAAC;gBACtB,IAAI,EAAE,UAAU;gBAChB,MAAM,EAAE,OAAO,CAAC,MAAM;gBACtB,IAAI,EAAE,eAAe;aACxB,CAAC,CAAC;QACP,CAAC;QAED,YAAY,EAAE,SAAS,YAAY,CAAC,IAAI,EAAE,mBAAmB;YACzD,IAAM,IAAI,GAAG,IAAI,CAAC;YAClB,IAAM,IAAI,GAAG,SAAS,CAAC;YACvB,IAAM,UAAU,GAAG;gBACf,IAAI,EAAE,IAAI,CAAC,IAAI;gBACf,GAAG,EAAE,IAAI,CAAC,GAAG;gBACb,KAAK,EAAE,IAAI,CAAC,UAAU;gBACtB,UAAU,EAAE,mBAAmB,CAAC,IAAI;aACvC,CAAC;YAEF,OAAO,IAAI,CAAC,gBAAgB;iBACvB,iBAAiB,CAAC,sCAAsC,EAAE,UAAU,CAAC;iBACrE,IAAI,CAAC;gBACF,OAAO,YAAY,CAAC,SAAS,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,IAAI,CAAC;oBAC9D,IAAI,CAAC,gBAAgB,CAAC,iBAAiB,CACnC,qCAAqC,EACrC,UAAU,CACb,CAAC;gBACN,CAAC,CAAC,CAAC;YACP,CAAC,CAAC,CAAC;QACX,CAAC;QAED,iBAAiB,EAAE,SAAS,iBAAiB,CAAC,UAAU,EAAE,KAAK;YAC3D,IAAM,IAAI,GAAG,IAAI,CAAC;YAClB,IAAM,IAAI,GAAG,SAAS,CAAC;YACvB,IAAM,UAAU,GAAG;gBACf,IAAI,EAAE,UAAU,CAAC,IAAI;gBACrB,GAAG,EAAE,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG;gBAC5B,KAAK,EAAE,KAAK;aACf,CAAC;YAEF,OAAO,IAAI,CAAC,gBAAgB;iBACvB,iBAAiB,CAAC,2CAA2C,EAAE,UAAU,CAAC;iBAC1E,IAAI,CAAC;gBACF,OAAO,YAAY,CAAC,SAAS,CAAC,iBAAiB,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,IAAI,CAAC;oBACnE,IAAI,CAAC,gBAAgB,CAAC,iBAAiB,CACnC,0CAA0C,EAC1C,UAAU,CACb,CAAC;gBACN,CAAC,CAAC,CAAC;YACP,CAAC,CAAC,CAAC;QACX,CAAC;QAED,sBAAsB;QACtB,WAAW,EAAE;YACD,IAAA,YAAY,GAAK,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,aAAjC,CAAkC;YACtD,OAAO,CACH,YAAY,CAAC,QAAQ,CAAC,4BAA4B,KAAK,GAAG;gBAC1D,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,KAAK,KAAK,CAAC,CACxC,CAAC;QACN,CAAC;QACD,mBAAmB;QACnB,QAAQ,EAAE;YACN,IAAM,sBAAsB,GAAG,IAAI,CAAC,KAAK;iBACpC,GAAG,CAAC,gBAAgB,CAAC;iBACrB,SAAS,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;YAClC,OAAO,sBAAsB,IAAI,sBAAsB,CAAC,GAAG,CAAC,MAAM,CAAC,KAAK,QAAQ,CAAC;QACrF,CAAC;QACD,2BAA2B;QAC3B,gBAAgB,EAAE;YACd,IAAM,sBAAsB,GAAG,IAAI,CAAC,KAAK;iBACpC,GAAG,CAAC,gBAAgB,CAAC;iBACrB,SAAS,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;YAClC,OAAO,CACH,sBAAsB;gBACtB,sBAAsB,CAAC,GAAG,CAAC,MAAM,CAAC,KAAK,QAAQ;gBAC/C,sBAAsB,CAAC,GAAG,CAAC,UAAU,CAAC,CACzC,CAAC;QACN,CAAC;QACD,6BAA6B;QAC7B,kBAAkB,EAAE;YAChB,IAAM,sBAAsB,GAAG,IAAI,CAAC,KAAK;iBACpC,GAAG,CAAC,gBAAgB,CAAC;iBACrB,SAAS,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;YAClC,OAAO,CACH,sBAAsB;gBACtB,CAAC,CAAC,CAAC,sBAAsB,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,mBAAmB,CAAC,CACrE,CAAC;QACN,CAAC;QAED,aAAa,EAAE;YACX,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;QAC3C,CAAC;QAED,qBAAqB,EAAE;YACX,IAAA,KAAK,GAAK,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,MAAjC,CAAkC;YAC/C,IAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,GAAG,CAAC;YAClD,IAAA,wBAAwB,GAAK,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,yBAAjC,CAAkC;YAClE,OAAO,wBAAwB,IAAI,CAAC,CAAC,QAAQ,IAAI,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAChG,CAAC;QAED,kBAAkB;QAClB,OAAO,EAAE,SAAS,OAAO;YACrB,IAAM,IAAI,GAAG,IAAI,CAAC;YAClB,IAAM,GAAG,GAAS,QAAQ,CAAC,OAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YAE3D,OAAO,IAAI,CAAC,gBAAgB;iBACvB,iBAAiB,CAAC,kCAAkC,EAAE,GAAG,CAAC;iBAC1D,IAAI,CAAC;gBACF,OAAO,IAAI,CAAC,QAAQ,EAAE,CAAC;YAC3B,CAAC,CAAC,CAAC;QACX,CAAC;QAED,QAAQ,EAAE,SAAS,QAAQ;YAAjB,iBA+DT;YA/D2B,cAAO;iBAAP,UAAO,EAAP,qBAAO,EAAP,IAAO;gBAAP,yBAAO;;YAC/B,gDAAgD;YAChD,IAAM,SAAS,GAAS,QAAQ,CAAC,OAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAC9D,IAAM,GAAG,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;YAEzB,OAAO,IAAI,CAAC,gBAAgB;iBACvB,iBAAiB,CAAC,mCAAmC,EAAE,GAAG,CAAC;iBAC3D,IAAI,CAAC;gBACF,IAAM,OAAO,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;gBACrD,IAAM,QAAQ,GAAG,KAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC;gBAC3C,IAAI,OAAO,GAAG,EAAE,CAAC;gBACjB,IAAI,WAAW,GAAG,EAAE,CAAC;gBACb,IAAA,aAAa,GAAK,KAAK,CAAC,eAAe,CAAC,OAAO,CAAC,cAAnC,CAAoC;gBACzD,IAAM,IAAI,GAAG,KAAI,CAAC;gBAElB,IAAI,aAAa,IAAI,CAAC,KAAI,CAAC,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE;oBACpE,IAAI,KAAI,CAAC,YAAY,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,GAAG,EAAE;wBAC1C,sDAAsD;wBACtD,WAAW,GAAG,KAAK,CAAC,SAAS,CAAC,4BAA4B,CAAC,CAAC;wBAC5D,OAAO;4BACH,KAAK,CAAC,SAAS,CACX,2JAA2J,EAC3J,gBAAgB,EAChB,aAAa,CAChB;gCACD,KAAK,CAAC,SAAS,CACX,wFAAwF,CAC3F,CAAC;qBACT;yBAAM;wBACH,WAAW,GAAG,KAAK,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC;wBAC7D,OAAO,GAAG,KAAK,CAAC,SAAS,CACrB,6EAA6E,CAChF,CAAC;qBACL;oBAED,IAAM,MAAM,GAAG,KAAI,CAAC,WAAW,CAAC,SAAS,EAAE,CAAC;oBAE5C,OAAO,CACH,MAAM,CAAC,aAAa;wBACpB,MAAM,CAAC,aAAa,CAAC,OAAO,EAAE,WAAW,EAAE,KAAK,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC,CAC1E,CAAC;iBACL;gBAED,2CAA2C;gBAC3C,6CAA6C;gBAC7C,IACI,KAAI,CAAC,KAAK;oBACV,KAAI,CAAC,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC;oBAC9B,CAAC,KAAI,CAAC,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,oBAAoB,CAAC;wBACrD,KAAI,CAAC,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;oBACjD,QAAQ,CAAC,MAAM,KAAK,CAAC,EACvB;oBACE,MAAM,CAAC,QAAQ,GAAG,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;oBAClD,OAAO,MAAM,CAAC,QAAQ,EAAE,CAAC,MAAM,EAAE,CAAC;iBACrC;gBAED,OAAO,YAAY,CAAC,SAAS,CAAC,OAAO,CAAC,KAAK,CAAC,KAAI,EAAE,IAAI,CAAC,CAAC,IAAI,CAAC;oBACzD,OAAO,IAAI,CAAC,gBAAgB,CAAC,iBAAiB,CAC1C,iCAAiC,EACjC,GAAG,CACN,CAAC;gBACN,CAAC,CAAC,CAAC;YACP,CAAC,CAAC,CAAC;QACX,CAAC;QAED,oEAAoE;QACpE,mCAAmC;QACnC,6BAA6B;QAC7B,aAAa,EAAE,UAAS,OAAO;YAAhB,iBAiDd;YAhDG,IAAM,gBAAgB,GAAG,MAAM,CAAC,QAAQ,EAAE,CAAC;YAE3C,OAAO;iBACF,IAAI,CAAC;gBACF,IAAM,YAAY,GAAG,KAAI,CAAC,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;gBACpD,IAAM,UAAU,GAAG,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;gBAClD,IAAI,OAAO,GAAG,KAAK,CAAC;gBAEpB,IAAI,UAAU,EAAE;oBACZ,IAAI,UAAU,KAAK,SAAS,IAAI,UAAU,KAAK,UAAU,EAAE;wBACvD,gBAAgB,CAAC,WAAW,CAAC,KAAI,CAAC,CAAC;wBACnC,OAAO,GAAG,IAAI,CAAC;qBAClB;yBAAM,IAAI,UAAU,KAAK,OAAO,EAAE;wBAC/B,+DAA+D;wBAC/D,IAAM,UAAU,GAAG,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;wBAClD,IACI,UAAU;4BACV,CAAC,UAAU,KAAK,kCAAkC;gCAC9C,UAAU,KAAK,8BAA8B;gCAC7C,UAAU,KAAK,kCAAkC,CAAC,EACxD;4BACE,IACI,YAAY,CAAC,GAAG,CAAC,sBAAsB,CAAC;gCACxC,YAAY,CAAC,GAAG,CAAC,0BAA0B,CAAC,EAC9C;gCACE,IAAM,IAAI,GAAG,IAAI,uBAAuB,CAAC;oCACrC,MAAM,EAAE,KAAI,CAAC,WAAW,CAAC,SAAS,EAAE;oCACpC,WAAW,EAAE,KAAI,CAAC,WAAW;oCAC7B,MAAM,EAAE,KAAI;oCACZ,QAAQ,EAAE,gBAAgB;oCAC1B,YAAY,EAAE,YAAY;iCAC7B,CAAC,CAAC;gCACH,IAAI,CAAC,WAAW,EAAE,CAAC;gCACnB,OAAO,GAAG,IAAI,CAAC;6BAClB;yBACJ;qBACJ;iBACJ;gBAED,IAAI,CAAC,OAAO,EAAE;oBACV,gBAAgB,CAAC,UAAU,CAAC,KAAI,CAAC,CAAC;iBACrC;YACL,CAAC,CAAC;iBACD,IAAI,CAAC;gBACF,gBAAgB,CAAC,UAAU,CAAC,KAAI,CAAC,CAAC;YACtC,CAAC,CAAC,CAAC;YAEP,OAAO,gBAAgB,CAAC,OAAO,EAAE,CAAC;QACtC,CAAC;KACJ,CAAC,CAAC;IAEH,OAAS,iBAAiB,CAAC","file":"OrderWizard.Router.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"OrderWizard.Router\"/>\n/// <reference path=\"../../../Commons/Utilities/JavaScript/UnderscoreExtended.d.ts\" />\n\nimport '../../../Commons/LiveOrder/JavaScript/LiveOrder.Model';\n\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { ProfileModel } from '../../../Commons/Profile/JavaScript/Profile.Model';\n\nimport WizardRouter = require('../../Wizard/JavaScript/Wizard.Router');\nimport Session = require('../../../Commons/Session/JavaScript/Session');\nimport OrderWizardStep = require('./OrderWizard.Step');\nimport OrderWizardThreeDSecure = require('../../OrderWizard.Module.PaymentMethod/JavaScript/OrderWizard.Module.PaymentMethod.ThreeDSecure');\nimport OrderWizardModel = require('./OrderWizard.Model');\nimport OrderWizardView = require('./OrderWizard.View');\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\n// @class OrderWizard.Router @extends Wizard.Router\nconst OrderWizardRouter: any = WizardRouter.extend({\n    // @property {OrderWizard.Step} step\n    step: OrderWizardStep,\n    view: OrderWizardView,\n    // @method initialize\n    initialize: function() {\n        this.orderWizardModel = OrderWizardModel.getInstance();\n\n        this.init_promise = WizardRouter.prototype.initialize.apply(this, arguments);\n        this.application.waitForPromise(this.init_promise);\n\n        this.profileModel = ProfileModel.getInstance();\n\n        const payment_methods = this.model.get('paymentmethods');\n        const payment_method_credit_card = payment_methods.findWhere({ type: 'creditcard' });\n        const credit_card =\n            payment_method_credit_card && payment_method_credit_card.get('creditcard');\n\n        // remove temporal credit card.\n        if (credit_card && credit_card.internalid === '-temporal-') {\n            payment_methods.remove(payment_method_credit_card);\n        }\n\n        const { startCheckoutWizard } = this.application.getConfig();\n        if (startCheckoutWizard && !~_.indexOf(this.stepsOrder, '')) {\n            const pageType = this.application.getComponent('PageType');\n\n            pageType.registerPageType({\n                name: 'checkout',\n                routes: ['', '?:options'],\n                callback: _.bind(this.startWizard, this),\n                defaultTemplate: {\n                    name: 'wizard.tpl',\n                    displayName: 'Order Wizard Default',\n                    thumbnail: Utils.getThemeAbsoluteUrlOfNonManagedResources(\n                        'img/default-layout-checkout.png'\n                    )\n                }\n            });\n        }\n    },\n    // @method startWizard\n    startWizard: function() {\n        this.navigate(this.getFirstStepUrl(), { trigger: true, replace: true });\n    },\n\n    _registerPageType: function _registerPageType(options) {\n        const pageType = this.application.getComponent('PageType');\n\n        pageType.registerPageType({\n            name: 'checkout',\n            routes: options.routes,\n            view: OrderWizardView\n        });\n    },\n\n    _compileStep: function _compileStep(step, step_group_instance) {\n        const self = this;\n        const args = arguments;\n        const event_data = {\n            name: step.name,\n            url: step.url,\n            index: step.step_index,\n            group_name: step_group_instance.name\n        };\n\n        return this.orderWizardModel\n            .cancelableTrigger('before:OrderWizardRouter.compileStep', event_data)\n            .then(function() {\n                return WizardRouter.prototype._compileStep.apply(self, args).done(function() {\n                    self.orderWizardModel.cancelableTrigger(\n                        'after:OrderWizardRouter.compileStep',\n                        event_data\n                    );\n                });\n            });\n    },\n\n    _compileStepGroup: function _compileStepGroup(step_group, index) {\n        const self = this;\n        const args = arguments;\n        const event_data = {\n            name: step_group.name,\n            url: step_group.steps[0].url,\n            index: index\n        };\n\n        return this.orderWizardModel\n            .cancelableTrigger('before:OrderWizardRouter.compileStepGroup', event_data)\n            .then(function() {\n                return WizardRouter.prototype._compileStepGroup.apply(self, args).done(function() {\n                    self.orderWizardModel.cancelableTrigger(\n                        'after:OrderWizardRouter.compileStepGroup',\n                        event_data\n                    );\n                });\n            });\n    },\n\n    // @method hidePayment\n    hidePayment: function(): boolean {\n        const { siteSettings } = this.application.getConfig();\n        return (\n            siteSettings.checkout.hidepaymentpagewhennobalance === 'T' &&\n            this.model.get('summary').total === 0\n        );\n    },\n    // @method isPaypal\n    isPaypal: function() {\n        const selected_paymentmethod = this.model\n            .get('paymentmethods')\n            .findWhere({ primary: true });\n        return selected_paymentmethod && selected_paymentmethod.get('type') === 'paypal';\n    },\n    // @method isPaypalComplete\n    isPaypalComplete: function() {\n        const selected_paymentmethod = this.model\n            .get('paymentmethods')\n            .findWhere({ primary: true });\n        return (\n            selected_paymentmethod &&\n            selected_paymentmethod.get('type') === 'paypal' &&\n            selected_paymentmethod.get('complete')\n        );\n    },\n    // @method isExternalCheckout\n    isExternalCheckout: function() {\n        const selected_paymentmethod = this.model\n            .get('paymentmethods')\n            .findWhere({ primary: true });\n        return (\n            selected_paymentmethod &&\n            !!~selected_paymentmethod.get('type').indexOf('external_checkout')\n        );\n    },\n\n    isMultiShipTo: function() {\n        return this.model.get('ismultishipto');\n    },\n\n    isAutoPopulateEnabled: function(): boolean {\n        const { forms } = this.application.getConfig();\n        const is_guest = this.profileModel.get('isGuest') === 'T';\n        const { autoPopulateNameAndEmail } = this.application.getConfig();\n        return autoPopulateNameAndEmail && ((is_guest && forms.loginAsGuest.showName) || !is_guest);\n    },\n\n    // @method runStep\n    runStep: function runStep() {\n        const self = this;\n        const url = (<any>Backbone.history).fragment.split('?')[0];\n\n        return this.orderWizardModel\n            .cancelableTrigger('before:OrderWizardRouter.runStep', url)\n            .then(function() {\n                return self._runStep();\n            });\n    },\n\n    _runStep: function _runStep(...args) {\n        // Computes the position of the user in the flow\n        const fragments = (<any>Backbone.history).fragment.split('?');\n        const url = fragments[0];\n\n        return this.orderWizardModel\n            .cancelableTrigger('before:OrderWizardRouter._runStep', url)\n            .then(() => {\n                const options = fragments.length ? fragments[1] : '';\n                const position = this.getStepPosition(url);\n                let content = '';\n                let page_header = '';\n                const { last_order_id } = Utils.parseUrlOptions(options);\n                const self = this;\n\n                if (last_order_id && !this.model.get('confirmation').get('internalid')) {\n                    if (this.profileModel.get('isGuest') !== 'T') {\n                        // checkout just finnished and user refreshed the doc.\n                        page_header = Utils.translate('Your Order has been placed');\n                        content =\n                            Utils.translate(\n                                'If you want to review your last order you can go to <a href=\"#\" data-touchpoint=\"$(0)\" data-hashtag=\"#/purchases/view/salesorder/$(1)\">Your Account</a>. ',\n                                'customercenter',\n                                last_order_id\n                            ) +\n                            Utils.translate(\n                                'Or you can continue Shopping on our <a href=\"/\" data-touchpoint=\"home\">Home Page</a>. '\n                            );\n                    } else {\n                        page_header = Utils.translate('Your Shopping Cart is empty');\n                        content = Utils.translate(\n                            'Continue Shopping on our <a href=\"/\" data-touchpoint=\"home\">Home Page</a>. '\n                        );\n                    }\n\n                    const layout = this.application.getLayout();\n\n                    return (\n                        layout.internalError &&\n                        layout.internalError(content, page_header, Utils.translate('Checkout'))\n                    );\n                }\n\n                // if you have already placed the order you\n                // can not be in any other step than the last\n                if (\n                    this.model &&\n                    this.model.get('confirmation') &&\n                    (this.model.get('confirmation').get('confirmationnumber') ||\n                        this.model.get('confirmation').get('tranid')) &&\n                    position.toLast !== 0\n                ) {\n                    window.location = Session.get('touchpoints.home');\n                    return jQuery.Deferred().reject();\n                }\n\n                return WizardRouter.prototype.runStep.apply(this, args).then(function() {\n                    return self.orderWizardModel.cancelableTrigger(\n                        'after:OrderWizardRouter.runStep',\n                        url\n                    );\n                });\n            });\n    },\n\n    // @method start3DSecure Start the process of 3D Secure CC payments.\n    // @param {jQuery.Deferred} promise\n    // @returns {jQuery.Deferred}\n    start3DSecure: function(promise) {\n        const wrapper_deferred = jQuery.Deferred();\n\n        promise\n            .done(() => {\n                const confirmation = this.model.get('confirmation');\n                const statuscode = confirmation.get('statuscode');\n                let success = false;\n\n                if (statuscode) {\n                    if (statuscode === 'success' || statuscode === 'redirect') {\n                        wrapper_deferred.resolveWith(this);\n                        success = true;\n                    } else if (statuscode === 'error') {\n                        // Order is not success since payment authorization is required\n                        const reasoncode = confirmation.get('reasoncode');\n                        if (\n                            reasoncode &&\n                            (reasoncode === 'ERR_WS_REQ_PAYMENT_AUTHORIZATION' ||\n                                reasoncode === 'ERR_WS_REQ_SHOPPER_CHALLENGE' ||\n                                reasoncode === 'ERR_WS_REQ_DEVICE_AUTHENTICATION')\n                        ) {\n                            if (\n                                confirmation.get('paymentauthorization') ||\n                                confirmation.get('authenticationformaction')\n                            ) {\n                                const view = new OrderWizardThreeDSecure({\n                                    layout: this.application.getLayout(),\n                                    application: this.application,\n                                    wizard: this,\n                                    deferred: wrapper_deferred,\n                                    confirmation: confirmation\n                                });\n                                view.showInModal();\n                                success = true;\n                            }\n                        }\n                    }\n                }\n\n                if (!success) {\n                    wrapper_deferred.rejectWith(this);\n                }\n            })\n            .fail(() => {\n                wrapper_deferred.rejectWith(this);\n            });\n\n        return wrapper_deferred.promise();\n    }\n});\n\nexport = OrderWizardRouter;\n"]}