{"version":3,"sources":["OrderWizard.Module.MultiShipTo.EnableLink.ts"],"names":[],"mappings":"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","file":"OrderWizard.Module.MultiShipTo.EnableLink.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"OrderWizard.Module.MultiShipTo.EnableLink\"/>\n\nimport * as _ from 'underscore';\nimport * as order_wizard_msr_enablelink_module_tpl from 'order_wizard_msr_enablelink_module.tpl';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport { WizardStepModule } from '../../Wizard/JavaScript/Wizard.StepModule';\nimport { GlobalViewsMessageView } from '../../../Commons/GlobalViews/JavaScript/GlobalViews.Message.View';\n\nimport GlobalViewsConfirmationView = require('../../../Commons/GlobalViews/JavaScript/GlobalViews.Confirmation.View');\nimport OrderWizardModuleMultiShipToRemovedPromoCodes = require('./OrderWizard.Module.MultiShipTo.RemovedPromoCodes');\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\n// @class OrderWizard.Module.MultiShipTo.EnableLink @extend Wizard.Module\nexport = WizardStepModule.extend({\n    // @property {Function} template\n    template: order_wizard_msr_enablelink_module_tpl,\n\n    className: 'OrderWizard.Module.MultiShipTo.EnableLink',\n\n    events: {\n        'click [data-action=\"change-status-multishipto\"]': 'toggleMultiShipTo',\n        'click [data-action=\"order-wizard-msr-promocodes-undo\"]': 'revertMultiShipToAndPromoCodes'\n    },\n\n    // @method initialize Override default method to attach current module on wizard's model events\n    // @return {Void}\n    initialize: function initialize() {\n        WizardStepModule.prototype.initialize.apply(this, arguments);\n\n        if (!this.wizard.model._events['toggle-multi-ship-to']) {\n            this.wizard.model.on('toggle-multi-ship-to', this.toggleMultiShipTo, this);\n            this.wizard.model.on('update-multi-ship-to-status', this.toggleMultiShipTo, this);\n            this.wizard.model.on('ismultishiptoUpdated', this.render, this);\n        }\n        this.wizard.closedModal = this.wizard.pressedModalButton = false;\n    },\n\n    // @method isActive Determines if the current module is valid to be shown and operate with\n    // @return {Boolean}\n    isActive: function isActive(): boolean {\n        const shippable_items = this.wizard.model.getShippableLines();\n        const siteSettings = this.wizard.application.getConfig().siteSettings || {};\n        return (\n            siteSettings.isMultiShippingRoutesEnabled &&\n            (shippable_items.length > 1 ||\n                (shippable_items.length === 1 && shippable_items[0].get('quantity') > 1)) &&\n            !this.wizard.model.getPickupInStoreLines().length\n        );\n    },\n\n    // @method toggleMultiShipTo Toggle the MST status of the order\n    // @return {jQuery.Deferred}\n    toggleMultiShipTo: function toggleMultiShipTo() {\n        if (!this.wizard.model.get('ismultishipto')) {\n            // These unsets are silent in order to avoid problems with other modules\n            this.wizard.model.set('shipmethod', null, { silent: true });\n            this.wizard.model.set('sameAs', false, { silent: true });\n            this.wizard.model.set('shipaddress', null, { silent: true });\n        }\n\n        const self = this;\n        this.wizard.model.set('ismultishipto', !this.wizard.model.get('ismultishipto'));\n\n        return this.wizard.model.save().done(function() {\n            self.wizard.model.trigger('ismultishiptoUpdated');\n\n            self.wizard.invalidPromocodes = self.wizard.model.get('automaticallyremovedpromocodes');\n            self.wizard.model.unset('automaticallyremovedpromocodes');\n            Backbone.history.navigate(self.options.change_url || '/', { trigger: true });\n            self.render();\n            if (self.wizard.invalidPromocodes && self.wizard.invalidPromocodes.length) {\n                self.removedPromocodesConfirmation(self.wizard.invalidPromocodes);\n            }\n        });\n    },\n\n    // @method removedPromocodesConfirmation\n    // @param {Array<LiveOrder.Model.PromoCode>} invalid_promocodes\n    // @return {Void}\n    removedPromocodesConfirmation: function removedPromocodesConfirmation() {\n        const removedPromocodesConfirmationView = new GlobalViewsConfirmationView({\n            callBack: _.bind(this.revertMultiShipToAndPromoCodesCallback, this),\n            cancelCallBack: _.bind(this.canceledModalCallback, this),\n            confirmLabel: Utils.translate('Cancel and Keep the Promotions'),\n            cancelLabel: Utils.translate('Continue Without them'),\n            className: 'order-wizard-msr-removed-promocodes-confirmation',\n            title: Utils.translate('Promotions not Supported'),\n            view: OrderWizardModuleMultiShipToRemovedPromoCodes,\n            viewParameters: {\n                invalidPromocodes: this.wizard.invalidPromocodes\n            },\n            autohide: true\n        });\n\n        const self = this;\n        removedPromocodesConfirmationView.on('modal-close', function() {\n            self.wizard.closedModal = true;\n            if (!self.wizard.pressedModalButton) {\n                // Refresh\n                Backbone.history.navigate(this.options.change_url || '/', { trigger: true });\n            }\n        });\n\n        this.wizard.closedModal = this.wizard.pressedModalButton = false;\n        this.wizard.application.getLayout().showInModal(removedPromocodesConfirmationView);\n    },\n\n    // @method canceledModalCallback\n    // @return {Void}\n    canceledModalCallback: function canceledModalCallback() {\n        this.wizard.pressedModalButton = true;\n    },\n\n    // @method revertMultiShipToAndPromoCodesCallback\n    // @return {Void}\n    revertMultiShipToAndPromoCodesCallback: function revertMultiShipToAndPromoCodesCallback() {\n        this.wizard.pressedModalButton = true;\n        this.revertMultiShipToAndPromoCodes();\n    },\n\n    // @method revertMultiShipToAndPromoCodesCallback\n    // @return {jQuery.Deferred}\n    revertMultiShipToAndPromoCodes: function revertMultiShipToAndPromoCodes() {\n        const new_promocodes = (this.wizard.model.get('promocodes') || []).concat(\n            this.wizard.invalidPromocodes\n        );\n\n        const save = this.wizard.model.save({ promocodes: new_promocodes, ismultishipto: false });\n\n        Backbone.history.navigate(this.options.change_url || '/', { trigger: true });\n        return save;\n    },\n\n    // @method render We override render to just render this module in case the multi ship to feature is enabled\n    // @return {Void}\n    render: function render() {\n        if (this.isActive()) {\n            this._render();\n            this.trigger('ready', true);\n        }\n    },\n\n    childViews: {\n        PromocodesRemovedWarning: function() {\n            let msg = Utils.translate(\n                'The following promotions are not supported when shipping to multiple addresses and have been removed: '\n            );\n            msg += '<span class=\"order-wizard-msr-removed-promocodes-list\">';\n            _.each(this.wizard.invalidPromocodes, function(e: any) {\n                msg += `${e.code}&nbsp;`;\n            });\n            msg += '</span><br />';\n            msg += '<a href=\"#\" data-action=\"order-wizard-msr-promocodes-undo\">';\n            msg += Utils.translate('Ship to a single address and re-apply codes.');\n            msg += '</a>';\n            return new GlobalViewsMessageView({ message: msg, type: 'warning', closable: true });\n        }\n    },\n\n    // @method getContext\n    // @return {OrderWizard.Module.MultiShipTo.EnableLink.Context}\n    getContext: function getContext() {\n        const showPromocodesRemovedWarning =\n            this.wizard.closedModal && !this.wizard.pressedModalButton;\n        if (showPromocodesRemovedWarning) {\n            // Reset warning after showing to make sure it's a one time operation.\n            this.wizard.closedModal = this.wizard.pressedModalButton = false;\n        }\n        // @class OrderWizard.Module.MultiShipTo.EnableLink.Context\n        return {\n            // @property {Boolean} isMultiShipToEnabled\n            isMultiShipToEnabled: !!this.model.get('ismultishipto'),\n            // @property {Boolean} showPromocodesRemovedWarning\n            showPromocodesRemovedWarning: showPromocodesRemovedWarning\n        };\n        // @class OrderWizard.Module.MultiShipTo.EnableLink\n    }\n});\n"]}