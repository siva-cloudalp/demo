{"version":3,"sources":["Subscriptions.Line.Model.ts"],"names":[],"mappings":"AAAA;;;;;EAKE;;;;;IAaW,QAAA,sBAAsB,GAAQ,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC;QAC7D,UAAU,EAAE;YAAA,iBAkBX;YAjBG,IAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;YAC9B,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,IAAI,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;YAC3C,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE;gBAC9B,IAAI,CAAC,gBAAgB,EAAE,CAAC;gBACxB,IAAI,CAAC,SAAS,EAAE,CAAC;aAChB;YAED,IAAI,CAAC,EAAE,CACH,iBAAiB,EACjB;gBACI,IAAI,KAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,KAAK,KAAI,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE;oBACtD,KAAI,CAAC,GAAG,CAAC,iBAAiB,EAAE,IAAI,CAAC,CAAC;iBACrC;gBACD,KAAI,CAAC,kBAAkB,EAAE,CAAC;YAC9B,CAAC,EACD,IAAI,CACP,CAAC;QACN,CAAC;QAED,iBAAiB,EAAjB;YACI,IACI,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC;gBAC1B,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,MAAM;gBACjC,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS;gBACvC,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS;gBACvC,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,UAAU;gBAClD,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,UAAU,CAAC,MAAM,EAC3D;gBACE,OAAO,IAAI,CAAC;aACf;YAED,OAAO,KAAK,CAAC;QACjB,CAAC;QAED,gBAAgB,EAAhB;YACI,IAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,UAAU,CAAC;YACvE,IAAM,kBAAkB,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;YAC1C,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;YACpC,IAAI,CAAC,GAAG,CAAC,kBAAkB,EAAE,kBAAkB,CAAC,CAAC;YAEjD,IACI,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,SAAS;gBACxC,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,KAAK,EAC7E;gBACE,IAAI,CAAC,GAAG,CAAC,mBAAmB,EAAE,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,SAAS,CAAC,CAAC;gBACtE,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;aAC/B;;gBAAM,IAAI,CAAC,GAAG,CAAC,mBAAmB,EAAE,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,KAAK,CAAC,CAAC;YAEzE,IAAI,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,SAAS,EAAE;gBAC/C,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC;gBACrE,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;aAC/B;QACL,CAAC;QAED,cAAc,EAAE;YACZ,IAAI,IAAI,CAAC,GAAG,CAAC,cAAc,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,KAAK,oBAAoB,EAAE;gBACzE,IAAI,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,EAAE;oBAC7B,OAAO,iBAAiB,CAAC;iBAC5B;gBACD,OAAO,YAAY,CAAC;aACvB;YAED,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAC9B,CAAC;QAED,kBAAkB,EAAE;YAChB,IAAG,IAAI,CAAC,iBAAiB,EAAE,EAAE;gBAC7B,IAAI,GAAG,GAAG,6DAA6D,CAAC;gBAExE,IAAM,MAAM,GAAwB;oBAChC,QAAQ,EAAE,iCAAiC;oBAC3C,QAAQ,EACJ,GAAG;wBACH,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC;wBACpB,IAAI;wBACJ,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC;wBACvB,IAAI;wBACJ,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC;wBACpB,SAAS;iBAChB,CAAC;gBAEF,GAAG,GAAG,KAAK,CAAC,cAAc,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;gBACxC,IAAM,MAAI,GAAG,IAAI,CAAC;gBAElB,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAS,MAAM;oBAChC,IAAM,MAAM,GAAQ,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;oBACnC,IAAI,QAAQ,CAAC,MAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,EAAE,EAAE,CAAC,KAAK,QAAQ,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;wBAC3E,MAAI,CAAC,GAAG,CAAC,iBAAiB,EAAE,QAAQ,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC,CAAC;wBACzD,MAAI,CAAC,GAAG,CAAC,2BAA2B,EAAE,KAAK,CAAC,cAAc,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE;4BACvE,MAAM,EAAE,KAAK;yBAChB,CAAC,CAAC;qBACV;gBACL,CAAC,CAAC,CAAC;aACF;QACL,CAAC;QAED,UAAU,EAAE;YACR,OAAO,CACH,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,KAAK,cAAc;gBACrC,CAAC,IAAI,CAAC,GAAG,CAAC,sBAAsB,CAAC,KAAK,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,sBAAsB,CAAC,KAAK,CAAC,CAAC,CACrF,CAAC;QACN,CAAC;QAED,SAAS,EAAE;YAAA,iBAgBV;YAfG,IAAM,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;YAC3D,IAAI,CAAC,GAAG,CAAC,aAAa,EAAE,UAAU,CAAC,WAAW,CAAC,CAAC;YAChD,IAAM,cAAc,GAAG,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,UAAC,cAAmB;gBACrE,OAAO;oBACH,eAAe,EAAE,cAAc,CAAC,OAAO;oBACvC,KAAK,EAAE,cAAc,CAAC,KAAK;oBAC3B,eAAe,EAAE,KAAK,CAAC,cAAc,CAAC,cAAc,CAAC,cAAc,CAAC;oBACpE,eAAe,EAAE,cAAc,CAAC,eAAe;oBAC/C,SAAS,EAAE,KAAI,CAAC,GAAG,CAAC,WAAW,CAAC;oBAChC,QAAQ,EAAE,KAAK;iBAClB,CAAC;YACN,CAAC,CAAC,CAAC;YACH,IAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;YAE9B,IAAI,CAAC,GAAG,CAAC,eAAe,EAAE,EAAE,aAAa,EAAE,cAAc,EAAE,CAAC,CAAC;QACjE,CAAC;QAED,kBAAkB,EAAlB;YACI,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE;gBAC1B,IAAM,MAAM,GAAG,EAAE,CAAC;gBAClB,IAAM,SAAS,GAAwB,EAAE,CAAC;gBAE1C,IAAI,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,aAAa,KAAK,MAAM,EAAE;oBACvD,SAAS,CAAC,WAAW,GAAG,MAAM,CAAC;iBAClC;qBAAM,IAAI,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,aAAa,KAAK,MAAM,EAAE;oBAC9D,SAAS,CAAC,WAAW,GAAG,OAAO,CAAC;iBACnC;gBACL,IACI,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,aAAa,KAAK,MAAM;oBACrD,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,MAAM,GAAG,CAAC,EACnC;oBACM,SAAS,CAAC,MAAM,GAAG,MAAM,CAAC;iBACjC;qBAAM,IAAI,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,aAAa,KAAK,MAAM;oBACxD,SAAS,CAAC,MAAM,GAAG,aAAa,CAAC;gBAErC,IAAI,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,EAAE;oBAC/D,SAAS,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;iBAC7D;gBACD,IAAM,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC;gBAC5C,IAAI,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,EAAE;oBAC/D,SAAS,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;iBAC7D;gBAED,SAAS,CAAC,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,cAAc,CAAC;gBACrE,SAAS,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,iBAAiB,CAAC;gBAEpE,IAAI,IAAI,CAAC,GAAG,CAAC,yBAAyB,CAAC,CAAC,wBAAwB,KAAK,UAAU,EAAE;oBAC7E,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE;wBACvB,SAAS,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,yBAAyB,CAAC,CAAC,wBAAwB,CAAC;qBACjF;oBACD,SAAS,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,aAAa,CAAC;iBAChE;qBAAM;oBACH,SAAS,CAAC,SAAS,GAAG,IAAI,CAAC;oBAC3B,SAAS,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,eAAe,CAAC;iBAC3E;gBAEG,OAAO,SAAS,CAAC;aACpB;QACL,CAAC;KACJ,CAAC,CAAC","file":"Subscriptions.Line.Model.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"Subscriptions.Line.Model\"/>\n/// <reference path=\"../../../Commons/Utilities/JavaScript/GlobalDeclarations.d.ts\" />\n\nimport * as _ from 'underscore';\n\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\n\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\nexport type SubscriptionsLineModel = any;\nexport const SubscriptionsLineModel: any = Backbone.Model.extend({\n    initialize: function() {\n        const item = this.get('item');\n        this.set('item', new Backbone.Model(item));\n        if (this.hasPriceIntervals()) {\n        this.setDefaultPrices();\n        this.setPrices();\n        }\n\n        this.on(\n            'change:quantity',\n            () => {\n                if (this.get('initialQuantity') !== this.get('quantity')) {\n                    this.set('quantityChanged', true);\n                }\n                this.setRecurringAmount();\n            },\n            this\n        );\n    },\n\n    hasPriceIntervals(): boolean {\n        if (\n            this.get('priceIntervals') &&\n            this.get('priceIntervals').length &&\n            this.get('priceIntervals')[0].pricePlan &&\n            this.get('priceIntervals')[0].pricePlan &&\n            this.get('priceIntervals')[0].pricePlan.priceTiers &&\n            this.get('priceIntervals')[0].pricePlan.priceTiers.length\n        ) {\n            return true;\n        }\n\n        return false;\n    },\n\n    setDefaultPrices(): void {\n        const price_tiers = this.get('priceIntervals')[0].pricePlan.priceTiers;\n        const default_price_tier = price_tiers[0];\n        this.set('priceTiers', price_tiers);\n        this.set('defaultPriceTier', default_price_tier);\n\n        if (\n            !!this.get('defaultPriceTier').minamount &&\n            this.get('defaultPriceTier').minamount > this.get('defaultPriceTier').value\n        ) {\n            this.set('defaultPriceValue', this.get('defaultPriceTier').minamount);\n            this.hasMinimumPrice = true;\n        } else this.set('defaultPriceValue', this.get('defaultPriceTier').value);\n\n        if (price_tiers[price_tiers.length - 1].maxamount) {\n            this.set('maxamount', price_tiers[price_tiers.length - 1].maxamount);\n            this.hasMaximumPrice = true;\n        }\n    },\n\n    getStatusLabel: function() {\n        if (this.get('isProcessing') || this.get('status') === 'PENDING_ACTIVATION') {\n            if (this.get('quantityChanged')) {\n                return 'Change quantity';\n            }\n            return 'PROCESSING';\n        }\n\n        return this.get('status');\n    },\n\n    setRecurringAmount: function() {\n        if(this.hasPriceIntervals()) {\n        let url = '/app/accounting/subscription/subscriptionrecurringamount.nl';\n\n        const params: Utils.UrlParameters = {\n            jrmethod: 'remoteObject.getRecurringAmount',\n            jrparams:\n                '[' +\n                this.get('quantity') +\n                ', ' +\n                this.get('pricePlanId') +\n                ', ' +\n                this.get('discount') +\n                ', true]'\n        };\n\n        url = Utils.addParamsToUrl(url, params);\n        const self = this;\n\n        jQuery.get(url).then(function(result) {\n            const amount: any = JSON.parse(result);\n                if (parseInt(self.get('recurringAmount'), 10) !== parseInt(amount.result, 10)) {\n                    self.set('recurringAmount', parseInt(amount.result, 10));\n                    self.set('recurringAmount_formatted', Utils.formatCurrency(amount.result), {\n                        silent: false\n                    });\n            }\n        });\n        }\n    },\n\n    isReadOnly: function() {\n        return (\n            this.get('status') !== 'NOT_INCLUDED' &&\n            (this.get('subscriptionLineType') === 1 || this.get('subscriptionLineType') === 3)\n        );\n    },\n\n    setPrices: function() {\n        const price_plan = this.get('priceIntervals')[0].pricePlan;\n        this.set('pricePlanId', price_plan.pricePlanId);\n        const price_schedule = _.map(this.get('priceTiers'), (price_interval: any) => {\n            return {\n                minimumquantity: price_interval.fromVal,\n                price: price_interval.value,\n                price_formatted: Utils.formatCurrency(price_interval.valueFormatted),\n                showSingleValue: price_interval.showSingleValue,\n                frequency: this.get('frequency'),\n                is_range: false\n            };\n        });\n        const item = this.get('item');\n\n        item.set('_priceDetails', { priceschedule: price_schedule });\n    },\n\n    getDefaultOfferStr(): Record<string, any> {\n        if (this.hasPriceIntervals()) {\n            const result = '';\n            const resultObj: Record<string, any> = {};\n\n            if (this.get('defaultPriceTier').pricingOption === '-101') {\n                resultObj.priceOption = 'RATE';\n            } else if (this.get('defaultPriceTier').pricingOption === '-102') {\n                resultObj.priceOption = 'FIXED';\n            }\n        if (\n            this.get('defaultPriceTier').pricingOption === '-102' &&\n            this.get('priceTiers').length > 1\n        ) {\n                resultObj.option = 'From';\n        } else if (this.get('defaultPriceTier').pricingOption === '-101')\n                resultObj.option = 'Starting at';\n\n            if (this.get('priceTiers') && this.get('priceTiers')[0].minamount) {\n                resultObj.minamount = this.get('priceTiers')[0].minamount;\n            }\n            const l = this.get('priceTiers').length - 1;\n            if (this.get('priceTiers') && this.get('priceTiers')[l].maxamount) {\n                resultObj.maxamount = this.get('priceTiers')[l].maxamount;\n            }\n\n            resultObj.defaultPrice = this.get('defaultPriceTier').valueFormatted;\n            resultObj.planType = this.get('pricePlanTypeObj').pricePlanTypeText;\n\n            if (this.get('subscriptionLineTypeObj').subscriptionlinetypeText !== 'One Time') {\n                if (!this.hasMinimumPrice) {\n                    resultObj.type = this.get('subscriptionLineTypeObj').subscriptionlinetypeText;\n                }\n                resultObj.frequency = this.get('frequencyObj').frequencyText;\n            } else {\n                resultObj.isOneTime = true;\n                resultObj.frequency = this.get('priceIntervals')[0].startOffsetUnit;\n        }\n\n            return resultObj;\n        }\n    }\n});\n"]}