{"version":3,"sources":["PaymentWizard.Module.Invoice.ts"],"names":[],"mappings":"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","file":"PaymentWizard.Module.Invoice.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"PaymentWizard.Module.Invoice\"/>\n\nimport * as payment_wizard_invoice_module_tpl from 'payment_wizard_invoice_module.tpl';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { WizardStepModule } from '../../Wizard/JavaScript/Wizard.StepModule';\nimport { ListHeaderView } from '../../../Commons/ListHeader/JavaScript/ListHeader.View';\n\nimport InvoiceCollection = require('../../Invoice/JavaScript/Invoice.Collection');\nimport PaymentWizardEditAmountView = require('./PaymentWizard.EditAmount.View');\nimport BackboneCollectionView = require('../../../Commons/Backbone.CollectionView/JavaScript/Backbone.CollectionView');\nimport RecordViewsSelectableActionableView = require('../../RecordViews/JavaScript/RecordViews.SelectableActionable.View');\nimport PaymentWizardModuleInvoiceSubjectView = require('./PaymentWizard.Module.Invoice.Subject.View');\nimport PaymentWizardModuleInvoiceActionView = require('./PaymentWizard.Module.Invoice.Action.View');\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\n// returns the amount of days based on milliseconds\nfunction getDays(milliseconds: number): number {\n    return milliseconds / 1000 / 60 / 60 / 24;\n}\n\n// @class PaymentWizard.Module.Invoice @extend Wizard.Module\nconst PaymentWizardModuleInvoice: any = WizardStepModule.extend({\n    template: payment_wizard_invoice_module_tpl,\n\n    className: 'PaymentWizard.Module.Invoice',\n\n    events: {\n        'click [data-action=\"edit\"]': 'editInvoice',\n        'click [data-action=\"remove\"]': 'removeInvoice'\n    },\n\n    initialize: function(options) {\n        this.wizard = options.wizard;\n        this.invoices = new InvoiceCollection();\n        this.invoices.reset(this.wizard.model.get('invoices').models);\n\n        // PaymentWizard.Module.Invoice.listHeader:\n        // manges sorting and filtering of the collection\n        this.listHeader = new ListHeaderView({\n            view: this,\n            application: options.wizard.application,\n            collection: this.invoices,\n            filters: this.filterOptions,\n            sorts: this.sortOptions,\n            selectable: false\n        });\n\n        this.addEventListeners();\n    },\n\n    addEventListeners: function() {\n        const self = this;\n        // Whenever the invoice collection changes, we re write\n        // this.invoices.on('reset', jQuery.proxy(this, 'render'));\n        this.invoices.on('reset', function() {\n            self.render();\n        });\n\n        // this.wizard.model.on('change:invoices_total', jQuery.proxy(this, 'render'));\n        this.wizard.model.on('change:invoices_total', function() {\n            self.render();\n        });\n\n        this.wizard.model.on('change:invoices', function() {\n            self.invoices.clearFilters();\n            self.invoices.reset(self.wizard.model.get('invoices').models);\n            self.invoices.original = self.invoices.clone();\n        });\n    },\n\n    // the render is called whenever the invoice collection is resetd\n    // to prevent multiple innecesary renders, we use this boolean flag\n    // so the \"real\" render will only happen if the step is present\n    present: function() {\n        this.renderable = true;\n        this.listHeader.updateCollection();\n    },\n\n    render: function() {\n        if (this.renderable) {\n            this._render();\n        }\n    },\n\n    // Array of default sort options\n    // sorts only apply on the current collection\n    // which might be a filtered version of the original\n    sortOptions: [\n        {\n            value: 'duedate',\n            name: Utils.translate('By Due Date'),\n            selected: true,\n            sort: function() {\n                return this.models.sort(function(invoiceOne, invoiceTwo) {\n                    const milli_inv_one = invoiceOne.get('dueinmilliseconds') || 0;\n                    const milli_inv_two = invoiceTwo.get('dueinmilliseconds') || 0;\n\n                    if (milli_inv_one !== milli_inv_two) {\n                        return milli_inv_one < milli_inv_two ? -1 : 1;\n                    }\n\n                    return invoiceOne.get('tranid') < invoiceTwo.get('tranid') ? -1 : 1;\n                });\n            }\n        },\n        {\n            value: 'invoicenumber',\n            name: Utils.translate('By Invoice Number'),\n            sort: function() {\n                return this.sortBy(function(invoice) {\n                    return invoice.get('tranid');\n                });\n            }\n        },\n        {\n            value: 'amountdue',\n            name: Utils.translate('By Amount Due'),\n            sort: function() {\n                return this.sortBy(function(invoice) {\n                    return invoice.get('due') ? invoice.get('due') : invoice.get('amount');\n                });\n            }\n        }\n    ],\n\n    editInvoice: function(e) {\n        const $target = jQuery(e.target);\n        const invoice_id = $target.closest('[data-id]').attr('data-id');\n        const invoice = this.invoices.get(invoice_id);\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.wizard.application.getLayout().showInModal(\n            new PaymentWizardEditAmountView({\n                application: this.wizard.applicationx,\n                parentView: this,\n                model: invoice,\n                type: 'invoice'\n            }),\n            {\n                application: this.wizard.application\n            }\n        );\n    },\n\n    // remove invoice\n    removeInvoice: function(e) {\n        const $target = jQuery(e.target);\n        const invoice_id = $target.closest('[data-id]').attr('data-id');\n        const invoice = this.invoices.get(invoice_id);\n\n        this.invoices.remove(invoice);\n\n        this.wizard.model.unselectInvoice(invoice);\n    },\n\n    // whenever this module is in the past\n    past: function() {\n        const { wizard } = this;\n        // if the payment model doesn't has any invoice selected\n        if (!wizard.model.getSelectedInvoices().length && !wizard.model.get('confirmation')) {\n            // that is just wrong, get back to the first step son\n            wizard.navigate(`/${wizard.steps[wizard.stepsOrder[0]].stepGroup.url}`);\n        }\n    },\n\n    childViews: {\n        'ListHeader.View': function() {\n            return this.listHeader;\n        },\n        'Invoices.Collection': function() {\n            const invoices_to_show = this.invoices.where({ apply: true }).map(function(invoice) {\n                const invoice_number = invoice.get('tranid') || invoice.get('refnum');\n                const navigable = !!invoice_number;\n\n                return new Backbone.Model({\n                    internalid: invoice.id,\n                    check: invoice.get('apply'),\n                    active: invoice.get('due') !== 0,\n                    navigable: navigable,\n\n                    url: `invoices/${invoice.id}`,\n                    title: navigable\n                        ? Utils.translate('Invoice #$(0)', invoice_number)\n                        : Utils.translate('Journal'),\n\n                    actionType: 'invoice',\n                    isPayFull: invoice.isPayFull(),\n\n                    columns: [\n                        {\n                            label: Utils.translate('Due date:'),\n                            type: 'date',\n                            name: 'original-amount',\n                            compositeKey: 'PaymentWizardModuleInvoiceSubjectView',\n                            composite: new PaymentWizardModuleInvoiceSubjectView({\n                                model: new Backbone.Model({\n                                    isoverdue: invoice.get('isOverdue'),\n                                    duedate: invoice.get('duedate'),\n                                    discountapplies: invoice.get('discountapplies'),\n                                    isPayFull: invoice.isPayFull(),\n                                    discount_formatted: invoice.get('discount_formatted'),\n                                    discdate: invoice.get('discdate'),\n                                    ispaid: invoice.get('due') === 0\n                                })\n                            })\n                        },\n                        {\n                            label: Utils.translate('Amount Due:'),\n                            type: 'currency',\n                            name: 'amount',\n                            value: invoice.get('due')\n                                ? invoice.get('due_formatted')\n                                : invoice.get('amount_formatted')\n                        }\n                    ]\n                });\n            });\n\n            return new BackboneCollectionView({\n                collection: invoices_to_show,\n                childView: RecordViewsSelectableActionableView,\n                viewsPerRow: 1,\n                childViewOptions: {\n                    actionView: PaymentWizardModuleInvoiceActionView,\n                    checkboxIsHidden: true\n                }\n            });\n        }\n    },\n\n    // @method getContext @return {PaymentWizard.Module.Invoice.Context}\n    getContext: function() {\n        // @class PaymentWizard.Module.Invoice.Context\n        return {\n            // @property {Boolean} isInvoiceLengthGreaterThan0\n            isInvoiceLengthGreaterThan0: !!this.invoices.where({ apply: true }).length\n        };\n    }\n});\n\nexport = PaymentWizardModuleInvoice;\n"]}