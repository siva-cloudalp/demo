{"version":3,"sources":["ApplicationOnlineLayout.ts"],"names":[],"mappings":"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","file":"ApplicationOnlineLayout.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name = \"ApplicationOnlineLayout\"/>\n\nimport * as _ from 'underscore';\nimport { WebPage as JsonldWebPage } from 'schema-dts';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { ApplicationLayout } from '../../../Commons/ApplicationSkeleton/JavaScript/ApplicationLayout';\nimport { Loggers } from '../../../Commons/Loggers/JavaScript/Loggers';\nimport { Configuration } from '../../../Commons/Utilities/JavaScript/Configuration';\nimport * as Backbone from '../../../Commons/Core/JavaScript/backbone/BackboneExtras';\nimport { FooterView } from '../../Footer/JavaScript/Footer.View';\nimport { JSONObject, JSONArray } from '../../../Commons/Utilities/JavaScript/Utils.Interfaces';\nimport { ChildViews } from '../../../Commons/Core/JavaScript/View';\nimport { ApplicationOnline } from './ApplicationOnline';\nimport { ProfileModel } from '../../../Commons/Profile/JavaScript/Profile.Model';\n\nimport HeaderView = require('../../Header/JavaScript/Header.View');\nimport ForbiddenErrorView = require('../../ErrorManagementOnline/JavaScript/ErrorManagementOnline.ForbiddenError.View');\nimport { UrlHelper } from '../../../Commons/UrlHelper/JavaScript/UrlHelper';\nimport Session = require('../../../Commons/Session/JavaScript/Session');\nimport GlobalViewsBreadcrumbView = require('../../GlobalViewsOnline/JavaScript/GlobalViews.Breadcrumb.View');\nimport ResponseErrorParser = require('../../ErrorManagementOnline/JavaScript/ErrorManagementOnline.ResponseErrorParser');\nimport GlobalViewsModalView = require('../../GlobalViewsOnline/JavaScript/GlobalViews.Modal.View');\n\nexport class ApplicationOnlineLayout extends ApplicationLayout {\n    private headerView;\n    private originalHeaderView;\n    private footerView;\n    private originalFooterView;\n    protected breadcrumbPrefix: any;\n    private breadcrumbPages: any;\n    private headerViewInstance: any;\n    private footerViewInstance: any;\n    private breadcrumbViewInstance: any;\n\n    public constructor(application: ApplicationOnline) {\n        super(application);\n\n        this.errorMessageParser = ResponseErrorParser;\n\n        this.headerView = HeaderView;\n        this.footerView = FooterView;\n\n        this.originalHeaderView = this.headerView;\n        this.originalFooterView = this.footerView;\n    }\n\n    protected updateOnReSize(): void {\n        this.updateHeader();\n        this.updateFooter();\n    }\n\n    public getBreadcrumbPrefix(): any {\n        return this.breadcrumbPrefix;\n    }\n\n    public getBreadcrumbPages(): any {\n        return this.breadcrumbPages;\n    }\n\n    private updateHeader(): void {\n        const siteSettings = this.application.getConfig().siteSettings || {};\n        if (siteSettings.sitetype === 'ADVANCED' && this.headerViewInstance) {\n            this.headerViewInstance.render();\n        }\n    }\n\n    private updateFooter(): void {\n        const siteSettings = this.application.getConfig().siteSettings || {};\n        if (siteSettings.sitetype === 'ADVANCED' && this.footerViewInstance) {\n            this.footerViewInstance.render();\n        }\n    }\n\n    protected updateLayout(): void {\n        // update the header and footer\n        this.headerView =\n            this.currentView.getHeaderView && this.currentView.getHeaderView()\n                ? this.currentView.getHeaderView()\n                : this.originalHeaderView;\n\n        this.footerView =\n            this.currentView.getFooterView && this.currentView.getFooterView()\n                ? this.currentView.getFooterView()\n                : this.originalFooterView;\n\n        if (\n            (this.headerViewInstance && !(this.headerViewInstance instanceof this.headerView)) ||\n            (this.footerViewInstance && !(this.footerViewInstance instanceof this.footerView))\n        ) {\n            const headerChildViewInst = this.getChildViewInstance('Header');\n            if (headerChildViewInst) {\n                headerChildViewInst.undelegateEvents();\n            }\n\n            const footerChildViewInst = this.getChildViewInstance('Footer');\n            if (footerChildViewInst) {\n                footerChildViewInst.undelegateEvents();\n            }\n\n            this.addChildViewInstances({\n                Header: this.childViews.Header,\n                Footer: this.childViews.Footer\n            });\n\n            this.render();\n        }\n\n        // update the breadcrumb\n        const breadcrumb_pages = this.currentView.getBreadcrumbPages\n            ? this.currentView.getBreadcrumbPages()\n            : null;\n\n        if (breadcrumb_pages && this.breadcrumbViewInstance) {\n            this.breadcrumbViewInstance.pages = this.updateCrumbtrail(breadcrumb_pages || []);\n            this.breadcrumbViewInstance.render();\n        } else {\n            this.hideBreadcrumb();\n        }\n    }\n\n    private updateCrumbtrail(pages: any): any {\n        if (!_.isArray(pages)) {\n            pages = [pages];\n        }\n\n        this.breadcrumbPages = _.union(this.breadcrumbPrefix, pages);\n\n        return this.breadcrumbPages;\n    }\n\n    private hideBreadcrumb(): void {\n        if (this.breadcrumbViewInstance) {\n            this.breadcrumbViewInstance.$el.empty();\n        }\n    }\n\n    protected processJsonLd(): void {\n        // If the JsonLd markup is selected on the configuration and the properties used\n        // in markup microdata do not exist, JsonLd script will be added to head.\n        const configuration = this.application.getConfig();\n        const structureddatamarkup = configuration.structureddatamarkup || {};\n        if (structureddatamarkup.type !== 'JSON-LD') {\n            return;\n        }\n\n        if (jQuery('[itemscope]').length || jQuery('[itemtype^=\"https://schema.org\"]').length) {\n            // eslint-disable-next-line no-console\n            console.warn(\n                'This template is not compatible with JsonLd. Template must be based on 20.1 Base Theme.'\n            );\n\n            return;\n        }\n\n        const fullJsonLd: JSONArray = [];\n        const promises = [\n            this.currentView.getViewJsonLd() as JSONObject,\n            this.breadcrumbViewInstance.getJsonLd() as JsonldWebPage\n        ];\n\n        jQuery.when(...promises).then(\n            // @ts-ignore\n            (...jsonLds: JSONArray): void => {\n                _.each(\n                    jsonLds,\n                    (jsonLdResult: JSONObject): void => {\n                        if (!_.isEmpty(jsonLdResult)) {\n                            let jsonLdWithContext = {\n                                '@context': 'https://schema.org'\n                            };\n                            jsonLdWithContext = { ...jsonLdWithContext, ...jsonLdResult };\n                            fullJsonLd.push(jsonLdWithContext);\n                        }\n                    }\n                );\n                if (!_.isEmpty(fullJsonLd)) {\n                    jQuery('head script[type=\"application/ld+json\"]').remove();\n                    jQuery(\n                        `<script type=\"application/ld+json\">${JSON.stringify(fullJsonLd)}</script>`\n                    ).appendTo('head');\n                }\n            }\n        );\n    }\n\n    public forbiddenError(): void {\n        const view = new ForbiddenErrorView({\n            application: this.application\n        });\n        view.showContent().done(\n            (): void => {\n                Loggers.getLogger().endLast('Navigation');\n            }\n        );\n    }\n\n    public getChildViews(): ChildViews {\n        const childViews = super.getChildViews();\n        childViews.Header = function(): any {\n            const options = {\n                application: this.application\n            };\n\n            if (this.currentView && this.currentView.getHeaderViewOptions) {\n                _.extend(options, this.currentView.getHeaderViewOptions());\n            }\n\n            const View = this.headerView;\n            this.headerViewInstance = new View(options);\n            return this.headerViewInstance;\n        };\n\n        childViews.Footer = function(): any {\n            const options = {\n                application: this.application\n            };\n\n            if (this.currentView && this.currentView.getFooterViewOptions) {\n                _.extend(options, this.currentView.getFooterViewOptions());\n            }\n\n            const View = this.footerView;\n            this.footerViewInstance = new View(options);\n            return this.footerViewInstance;\n        };\n\n        childViews['Global.Breadcrumb'] = function(): any {\n            this.breadcrumbViewInstance = new GlobalViewsBreadcrumbView({\n                pages: this.breadcrumbPages\n            });\n\n            return this.breadcrumbViewInstance;\n        };\n\n        return childViews;\n    }\n\n    public unauthorizedError(user_session_timedOut): void {\n        const { currentTouchpoint } = this.application.getConfig();\n        if (currentTouchpoint === 'login') {\n            // This case can happen when more than one concurrent XHR is made and both\n            // return a user session time-out error\n            return;\n        }\n        ProfileModel.getInstance().set({\n            isLoggedIn: 'F',\n            isGuest: 'F'\n        });\n\n        let base_url = UrlHelper.setUrlParameter(\n            Session.get('touchpoints.login'),\n            'origin',\n            currentTouchpoint\n        );\n        base_url = UrlHelper.setUrlParameter(\n            base_url,\n            'origin_hash',\n            (<any>Backbone.history).fragment\n        );\n        Configuration.currentTouchpoint = 'login';\n\n        window.location = user_session_timedOut\n            ? UrlHelper.setUrlParameter(base_url, 'timeout', 'T')\n            : base_url;\n    }\n\n    protected getGlobalModalViewClass(): any {\n        return GlobalViewsModalView;\n    }\n}\n"]}