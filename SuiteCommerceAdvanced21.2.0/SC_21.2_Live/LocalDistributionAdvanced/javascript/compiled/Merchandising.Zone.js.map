{"version":3,"sources":["Merchandising.Zone.ts"],"names":[],"mappings":"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","file":"Merchandising.Zone.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"Merchandising.Zone\"/>\n/// <reference path=\"../../../Commons/Utilities/JavaScript/GlobalDeclarations.d.ts\" />\n\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\n\nimport MerchandisingItemCollection = require('./Merchandising.Item.Collection');\nimport MerchandisingRule = require('./Merchandising.Rule');\nimport MerchandisingContext = require('./Merchandising.Context');\nimport MerchandisingView = require('./Merchandising.View');\nimport LiveOrderModel = require('../../../Commons/LiveOrder/JavaScript/LiveOrder.Model');\n\n// @module Merchandising\n\n// @class Merchandising.Zone\n// we declare a new version of the ItemCollection\n// to make sure the urlRoot doesn't get overridden\n// @constructor @param {HTMLElement|jQuery} element @param {Object} options\nconst MerchandisingZone = function MerchandisingZone(element, options) {\n    const application = options && options.application;\n    const layout = application && application.getLayout && application.getLayout();\n\n    if (!element || !layout) {\n        return;\n    }\n\n    this.$element = jQuery(element).empty();\n    // we try to get the model based on option.id (if passed) or the elements data id\n    this.model = MerchandisingRule.Collection.getInstance().get(\n        options.id || this.$element.data('id')\n    );\n\n    if (this.model && this.$element.length && !this.$element.hasClass(this.loadingClassNames)) {\n        this.options = options;\n        this.application = application;\n        this.items = new MerchandisingItemCollection();\n\n        this.context = new MerchandisingContext(\n            layout.modalCurrentView || layout.currentView || layout\n        );\n\n        this.initialize();\n    }\n};\n\n_.extend(MerchandisingZone.prototype, {\n    // @method initialize\n    // @return {Void}\n    initialize: function() {\n        this.addLoadingClass();\n        // the listeners MUST be added before the fetch ocurrs\n        this.addListeners();\n\n        // fetch the items\n        this.items.fetch({\n            cache: true,\n            data: this.getApiParams()\n        });\n    },\n\n    // @method addListeners install the listeners\n    // @return {Void}\n    addListeners: function(): void {\n        const { proxy } = jQuery;\n\n        this.items.on({\n            sync: proxy(this.excludeItems, this),\n            excluded: proxy(this.appendItems, this),\n            appended: proxy(this.removeLoadingClass, this),\n            error: proxy(this.handleRequestError, this)\n        });\n    },\n\n    // @method getApiParams precondition: this.model and this.options must be defined\n    // @return {Object}\n    getApiParams: function() {\n        const filters = this.parseApiFilterOptions();\n        const sorting = this.parseApiSortingOptions();\n\n        if (sorting.length) {\n            filters.sort = sorting.join(',');\n        }\n\n        // # Response\n        // parameters to be passed to the item's fetch query\n        return _.extend(\n            {\n                limit: this.getLimit(),\n                fieldset: this.model.get('fieldset')\n            },\n            filters\n        );\n    },\n\n    // @method parseApiFilterOptions @return {Object}\n    parseApiFilterOptions: function() {\n        const filters = {};\n\n        // parses the merchandising rule filters into the filters obj\n        _.each(this.model.get('filter'), function(rule_filter: any) {\n            filters[rule_filter.field_id] = rule_filter.field_value;\n        });\n\n        return this.context.getFilters(filters, this.model.get('within'));\n    },\n\n    // @method parseApiSortingOptions turn sorting obj into a string for the query @return {Array}\n    parseApiSortingOptions: function() {\n        return _.map(this.model.get('sort'), function(value: any) {\n            return `${value.field_id}:${value.dir}`;\n        });\n    },\n\n    // @method getLimit if there are items to get excluded from the collection.\n    // We need to ask for more items from the api because the filtering gets done after the request.\n    // @return {Number}\n    getLimit: function(): number {\n        const { model } = this;\n        let limit = model.get('show');\n        const exclude = model.get('exclude');\n\n        if (exclude.length) {\n            if (_.contains(exclude, '$cart')) {\n                limit += LiveOrderModel.getInstance().get('lines').length;\n            }\n\n            if (_.contains(exclude, '$current')) {\n                limit += this.context.getIdItemsToExclude().length;\n            }\n        }\n\n        return limit <= 100 ? limit : 100;\n    },\n\n    // @method excludeItems\n    excludeItems: function(): void {\n        const self = this;\n\n        _.each(this.model.get('exclude'), function(filter) {\n            self.applyFilterToItems(filter);\n        });\n\n        this.items.trigger('excluded');\n\n        return this;\n    },\n\n    // @method applyFilterToItems narrows down the collection if excludes set up on the merchandising rule\n    // @param {String} filter the type of item filtering, currently supported values are: ```'@cart'``` and ```'@current'```\n    applyFilterToItems: function(filter: string) {\n        const { items } = this;\n\n        switch (filter) {\n            case '$cart':\n                var item = null;\n\n                LiveOrderModel.getInstance()\n                    .get('lines')\n                    .each(function(line) {\n                        item = line.get('item');\n\n                        items.remove(\n                            items.get(item.get('_matrixParent').get('_id') || item.get('_id'))\n                        );\n                    });\n                break;\n\n            case '$current':\n                _.each(this.context.getIdItemsToExclude(), function(id) {\n                    items.remove(items.get(id));\n                });\n                break;\n        }\n\n        return this;\n    },\n\n    // @method appendItems\n    appendItems: function(): void {\n        const { items } = this;\n\n        if (items.length) {\n            if (this.model.get('template')) {\n                // we try to get the 'template' from the merchandising rule\n                const amd_optimize_trick_for_require = Utils.requireModules;\n                MerchandisingView.prototype.template = amd_optimize_trick_for_require(\n                    this.model.get('template')\n                );\n            }\n\n            const view = new MerchandisingView({\n                model: this.model,\n                items: items,\n                application: this.application\n            });\n\n            view.render();\n\n            this.$element.append(view.$el);\n\n            view.trigger('afterMerchandAppendToDOM');\n        }\n\n        items.trigger('appended');\n\n        // notify the layout that the content might have changed\n        this.options &&\n            this.options.application &&\n            this.options.application.getLayout().trigger('afterRender');\n\n        return this;\n    },\n\n    // @property {String} loadingClassNames\n    loadingClassNames: 'loading loading-merchandising-zone',\n\n    // @method addLoadingClass\n    addLoadingClass: function(): void {\n        this.$element.addClass(this.loadingClassNames);\n    },\n\n    // @method removeLoadingClass\n    removeLoadingClass: function(): void {\n        this.$element.removeClass(this.loadingClassNames);\n    },\n\n    // @method handleRequestError\n    handleRequestError: function(): void {\n        this.removeLoadingClass();\n        console.error('Merchandising Zone - Request Error', arguments);\n    }\n});\n\nexport = MerchandisingZone;\n"]}