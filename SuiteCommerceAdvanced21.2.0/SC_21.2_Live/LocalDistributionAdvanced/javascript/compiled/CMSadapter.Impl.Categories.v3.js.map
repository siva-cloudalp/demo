{"version":3,"sources":["CMSadapter.Impl.Categories.v3.ts"],"names":[],"mappings":"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","file":"CMSadapter.Impl.Categories.v3.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"CMSadapter.Impl.Categories.v3\"/>\n/// <reference path=\"../../../Commons/Utilities/JavaScript/GlobalDeclarations.d.ts\" />\n// @Typescript-partial\n\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport {\n    CategoriesCollection,\n    CollectionOptions\n} from '../../../Commons/Categories/JavaScript/Categories.Collection';\nimport { CmsObject, Application } from './CMSadapter.v3';\nimport { CategoryTree, Category } from '../../../ServiceContract/SC/Category/Category';\nimport { Configuration } from '../../SCA/JavaScript/Configuration';\nimport { ProfileModel } from '../../../Commons/Profile/JavaScript/Profile.Model';\n\nimport Categories = require('../../../Commons/Categories/JavaScript/Categories');\nimport FacetsRouter = require('../../../Commons/Facets/JavaScript/Facets.Router');\nimport FacetsModel = require('../../../Commons/Facets/JavaScript/Facets.Model');\nimport ItemModel = require('../../../Commons/Item/JavaScript/Item.Model');\nimport ItemCollection = require('../../../Commons/Item/JavaScript/Item.Collection');\nimport Backbone = require('../../../Commons/Utilities/JavaScript/backbone.custom');\n\nimport Deferred = JQuery.Deferred;\n\ninterface environmentAccount {\n    backendAccountDomain: string;\n}\n\ninterface previewSegmentApplyData {\n    pcv_all_items: boolean;\n    pcv_groups: string[];\n}\n\ninterface siteDateChangedData {\n    siteDate: string;\n}\n\ninterface CategoriesNavigateData {\n    url: string;\n}\n\nexport class CMSadapterImplCategories3 {\n    private cms: CmsObject;\n\n    private application: Application;\n\n    private currentDate: string;\n\n    private backendAccountDomain: string;\n\n    private pcvGroups: string;\n\n    private pcvAllItems: string;\n\n    private fullUrl: string;\n\n    public constructor(application: Application, cms: CmsObject) {\n        this.cms = cms;\n        this.application = application;\n        this.currentDate = null;\n        this.backendAccountDomain = null;\n        this.listenForCMS();\n    }\n\n    private listenForCMS(): void {\n        // CMS listeners - CMS tells us to do something, could fire anytime.\n\n        this.cms.on(\n            'categories:navigate',\n            (promise: Deferred<void>, data: CategoriesNavigateData) => {\n                FacetsModel.prototype.ignoreCache = true;\n\n                this.fullUrl = Utils.correctURL(data.url);\n\n                Backbone.history.navigate(this.fullUrl, { trigger: false });\n                // navigate event should not force the reload of all categories information\n                // but the app is not subscribed to any event to know when a category was updated\n                // so on every navigation the categories info is reloaded\n                this.reloadCategories().then(() => {\n                    promise.resolve();\n                });\n            }\n        );\n\n        this.cms.on('categories:reload', (promise: Deferred<void>) => {\n            this.setUpEndPoints()\n                .then(() => {\n                    this.reloadCategories()\n                        .then(function() {\n                            promise.resolve();\n                        })\n                        .fail(function() {\n                            promise.reject();\n                        });\n                })\n                .fail(function() {\n                    promise.reject();\n                });\n        });\n\n        this.cms.on('site:date:changed', (promise: Deferred<void>, data: siteDateChangedData) => {\n            this.setUpEndPoints()\n                .then(() => {\n                    this.currentDate = data.siteDate;\n                    this.changeServices();\n                    this.reloadCategories()\n                        .then(function() {\n                            promise.resolve();\n                        })\n                        .fail(function() {\n                            promise.reject();\n                        });\n                })\n                .fail(function() {\n                    promise.reject();\n                });\n        });\n\n        this.cms.on(\n            'preview:segment:apply',\n            (promise: Deferred<void>, data: previewSegmentApplyData) => {\n                this.setUpEndPoints()\n                    .then(() => {\n                        this.pcvAllItems = data.pcv_all_items ? 'T' : 'F';\n                        this.pcvGroups = data.pcv_groups ? data.pcv_groups.join() : '';\n\n                        SC.ENVIRONMENT.pcvGroups = this.pcvGroups;\n                        SC.ENVIRONMENT.pcvAllItems = this.pcvAllItems;\n\n                        this.changeServices();\n                        this.reloadCategories()\n                            .then(() => {\n                                promise.resolve();\n                            })\n                            .fail(() => {\n                                promise.reject();\n                            });\n                    })\n                    .fail(() => {\n                        promise.reject();\n                    });\n            }\n        );\n    }\n\n    private categoriesRefresh(menu: CategoryTree) {\n        Categories.setTopLevelCategoriesUrlComponents(menu);\n        // update the router with new urls\n        const router = new FacetsRouter(this.application);\n        router.addUrl(Categories.getTopLevelCategoriesUrlComponent(), 'categoryLoading');\n        Categories.addToNavigationTabs(menu);\n\n        this.refreshPLP();\n    }\n\n    private setUpEndPoints(): Deferred<void> {\n        const promise = jQuery.Deferred();\n\n        if (!this.backendAccountDomain) {\n            jQuery\n                .getJSON(\n                    Utils.getAbsoluteUrl(\n                        `services/NS_SC_Environment.ss?n=${SC.ENVIRONMENT.siteSettings.siteid}`,\n                        true\n                    )\n                )\n                .then((env: environmentAccount) => {\n                    this.backendAccountDomain = `https://${env.backendAccountDomain}`;\n                    promise.resolve();\n                });\n        } else {\n            promise.resolve();\n        }\n        return promise;\n    }\n\n    private reloadCategories(): JQueryXHR {\n        const options: CollectionOptions = {\n            backendAccountDomain: this.backendAccountDomain,\n            pcvGroups: this.pcvGroups,\n            pcvAllItems: this.pcvAllItems,\n            level: Configuration.get('categories.menuLevel'),\n            effectiveDate: this.currentDate\n        };\n\n        const collection = new CategoriesCollection(options);\n\n        return collection.fetch().done(menu => {\n            const categoriesMenu = menu ? menu.data : [];\n            this.categoriesRefresh(categoriesMenu);\n        });\n    }\n\n    private refreshPLP(): void {\n        const currentBaseUrl: string = Backbone.history.getFragment().split('/')[0];\n        if (\n            currentBaseUrl === Configuration.defaultSearchUrl ||\n            _.find(Categories.getTopLevelCategoriesUrlComponent(), (cat: string) => {\n                return cat.substring(1) === currentBaseUrl;\n            })\n        ) {\n            // if is a category or shop, reload the page\n            Backbone.history.loadUrl(Backbone.history.getFragment());\n        }\n    }\n\n    private changeServices(): void {\n        const self = this;\n\n        ProfileModel.getInstance().setSearchApiBaseUrl(this.backendAccountDomain);\n\n        function wrapItemsApiFetch(modelOrCollection) {\n            modelOrCollection.prototype.fetch = _.wrap(modelOrCollection.prototype.fetch, function(\n                fn,\n                options\n            ) {\n                options = Utils.deepExtend(options || {}, {\n                    cache: false,\n                    data: {\n                        as_of_date: self.currentDate,\n                        force_avoid_redirect: true\n                    },\n                    xhrFields: {\n                        withCredentials: true\n                    },\n                    crossDomain: true\n                });\n                // The 'true' value prevents jQuery ajax from sending the 'X-SC-Touchpoint' header, it's not supported\n                // by CORS request to the items API\n                SC.dontSetRequestHeaderTouchpoint = true;\n                const fethReturn = fn.call(this, options);\n                SC.dontSetRequestHeaderTouchpoint = false;\n                return fethReturn;\n            });\n        }\n        wrapItemsApiFetch(ItemModel);\n        wrapItemsApiFetch(ItemCollection);\n        wrapItemsApiFetch(FacetsModel);\n    }\n}\n"]}